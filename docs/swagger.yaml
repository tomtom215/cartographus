# Cartographus - Media Server Analytics and Geographic Visualization
# Copyright 2026 Tom F. (tomtom215)
# SPDX-License-Identifier: AGPL-3.0-or-later
# https://github.com/tomtom215/cartographus
basePath: /api/v1
definitions:
  models.APIError:
    properties:
      code:
        type: string
      details:
        additionalProperties: true
        type: object
      message:
        type: string
    type: object
  models.APIResponse:
    properties:
      data: {}
      error:
        $ref: '#/definitions/models.APIError'
      metadata:
        $ref: '#/definitions/models.Metadata'
      status:
        type: string
    type: object
  models.CountryStats:
    properties:
      country:
        type: string
      playback_count:
        type: integer
      unique_users:
        type: integer
    type: object
  models.HealthStatus:
    properties:
      database_connected:
        type: boolean
      last_sync_time:
        type: string
      status:
        type: string
      tautulli_connected:
        type: boolean
      uptime_seconds:
        type: number
      version:
        type: string
    type: object
  models.LocationStats:
    properties:
      avg_completion:
        type: number
      city:
        type: string
      country:
        type: string
      first_seen:
        type: string
      last_seen:
        type: string
      latitude:
        type: number
      longitude:
        type: number
      playback_count:
        type: integer
      region:
        type: string
      unique_users:
        type: integer
    type: object
  models.Metadata:
    properties:
      query_time_ms:
        type: integer
      timestamp:
        type: string
    type: object
  models.PlaybackEvent:
    properties:
      audio_bitrate:
        type: integer
      audio_channel_layout:
        type: string
      audio_channels:
        description: Audio details
        type: string
      audio_codec:
        type: string
      audio_language:
        type: string
      audio_sample_rate:
        type: integer
      bitrate:
        type: integer
      container:
        description: Container and subtitle
        type: string
      content_rating:
        type: string
      created_at:
        type: string
      file_size:
        description: File metadata
        type: integer
      grandparent_title:
        type: string
      id:
        type: string
      ip_address:
        type: string
      library_name:
        type: string
      local:
        description: 0 or 1 flag
        type: integer
      location_type:
        type: string
      media_type:
        type: string
      parent_title:
        type: string
      paused_counter:
        type: integer
      percent_complete:
        type: integer
      platform:
        type: string
      play_duration:
        type: integer
      player:
        type: string
      relayed:
        description: 0 or 1 flag
        type: integer
      section_id:
        type: integer
      secure:
        description: Connection security
        type: integer
      session_key:
        type: string
      started_at:
        type: string
      stopped_at:
        type: string
      stream_audio_channels:
        type: string
      stream_audio_codec:
        type: string
      stream_audio_decision:
        type: string
      stream_bitrate:
        type: integer
      stream_container:
        type: string
      stream_video_decision:
        type: string
      stream_video_resolution:
        description: Stream quality fields (what was actually streamed vs source)
        type: string
      subtitle_codec:
        type: string
      subtitle_language:
        type: string
      subtitles:
        description: 0 or 1 flag
        type: integer
      title:
        type: string
      transcode_decision:
        type: string
      user_id:
        type: integer
      username:
        type: string
      video_bit_depth:
        type: integer
      video_bitrate:
        type: integer
      video_codec:
        type: string
      video_dynamic_range:
        description: Video details
        type: string
      video_framerate:
        type: string
      video_height:
        type: integer
      video_resolution:
        type: string
      video_width:
        type: integer
      year:
        type: integer
    type: object
  models.Stats:
    properties:
      database_size_bytes:
        type: integer
      last_sync_time:
        type: string
      recent_activity:
        type: integer
      top_countries:
        items:
          $ref: '#/definitions/models.CountryStats'
        type: array
      total_playbacks:
        type: integer
      unique_locations:
        type: integer
      unique_users:
        type: integer
    type: object
host: localhost:3857
info:
  contact:
    name: GitHub Repository
    url: https://github.com/tomtom215/cartographus/issues
  description: |-
    Geographic visualization and analytics platform for Plex Media Server playback activity

    ## Features

    - **Interactive WebGL Map**: Visualize playback locations with clustering for 10,000+ points
    - **3D Globe View**: WebGL-accelerated 3D globe visualization
    - **32 Analytics Charts**: Powered by Apache ECharts across 5 themed sections
    - **Real-time Updates**: WebSocket-based live notifications
    - **Advanced Filtering**: 14+ filter dimensions (users, media types, platforms, codecs)
    - **Data Export**: CSV and GeoJSON export capabilities
    - **Progressive Web App**: Offline support with service worker

    ## Authentication

    Most endpoints require JWT authentication via HTTP-only cookie.
    Use `/api/v1/auth/login` to obtain a token, which will be automatically included in subsequent requests.

    ## Rate Limiting

    Default rate limit: 100 requests per minute per IP address.
    Rate limit headers are included in responses: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`.

    ## Performance

    - API response times (p95): <100ms
    - Map rendering: 60 FPS
    - Data sync (10k events): <30s
    - In-memory caching: 5-minute TTL for analytics

    ## Error Responses

    All error responses follow this format:
    ```json
    {
    "status": "error",
    "data": null,
    "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message",
    "details": {}
    },
    "metadata": {
    "timestamp": "2025-11-18T12:34:56Z"
    }
    }
    ```
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  title: Cartographus API
  version: "1.0"
paths:
  /auth/login:
    post:
      consumes:
      - application/json
      description: Authenticates user with username and password, returns JWT token
        in HTTP-only cookie
      parameters:
      - description: Login credentials
        in: body
        name: credentials
        required: true
        schema:
          properties:
            password:
              type: string
            username:
              type: string
          type: object
      produces:
      - application/json
      responses:
        "200":
          description: Authentication successful
          schema:
            allOf:
            - $ref: '#/definitions/models.APIResponse'
            - properties:
                data:
                  properties:
                    expires_at:
                      type: string
                    token:
                      type: string
                  type: object
              type: object
        "400":
          description: Invalid request body
          schema:
            $ref: '#/definitions/models.APIResponse'
        "401":
          description: Invalid credentials
          schema:
            $ref: '#/definitions/models.APIResponse'
        "403":
          description: Authentication disabled
          schema:
            $ref: '#/definitions/models.APIResponse'
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Authenticate user
      tags:
      - Auth
  /export/locations/geojson:
    get:
      consumes:
      - application/json
      description: Exports location statistics in GeoJSON format for use in GIS applications
        and mapping tools
      produces:
      - application/geo+json
      responses:
        "200":
          description: GeoJSON file download
          schema:
            type: file
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Export locations as GeoJSON
      tags:
      - Export
  /export/playbacks/csv:
    get:
      consumes:
      - application/json
      description: Exports complete playback history with all metadata to CSV format
        for external analysis
      parameters:
      - default: 10000
        description: Maximum number of records to export (1-100000)
        in: query
        maximum: 100000
        minimum: 1
        name: limit
        type: integer
      produces:
      - text/csv
      responses:
        "200":
          description: CSV file download
          schema:
            type: file
        "400":
          description: Invalid parameters
          schema:
            $ref: '#/definitions/models.APIResponse'
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Export playback history as CSV
      tags:
      - Export
  /health:
    get:
      consumes:
      - application/json
      description: Returns comprehensive health status including database connectivity,
        Tautulli connectivity, last sync time, and uptime
      produces:
      - application/json
      responses:
        "200":
          description: Health status retrieved successfully
          schema:
            allOf:
            - $ref: '#/definitions/models.APIResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.HealthStatus'
              type: object
      summary: Get system health status
      tags:
      - Core
  /health/live:
    get:
      consumes:
      - application/json
      description: Returns 200 OK if the process is alive, regardless of external
        dependencies. Used for Kubernetes liveness probes.
      produces:
      - application/json
      responses:
        "200":
          description: Service is alive
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Kubernetes liveness probe
      tags:
      - Core
  /health/ready:
    get:
      consumes:
      - application/json
      description: Returns 200 OK only if the service is ready to handle traffic (database
        and Tautulli are both connected). Returns 503 if not ready.
      produces:
      - application/json
      responses:
        "200":
          description: Service is ready
          schema:
            $ref: '#/definitions/models.APIResponse'
        "503":
          description: Service is not ready
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Kubernetes readiness probe
      tags:
      - Core
  /locations:
    get:
      consumes:
      - application/json
      description: Returns aggregated playback statistics by geographic location with
        support for 14+ filter dimensions
      parameters:
      - default: 100
        description: Maximum number of locations to return (1-1000)
        in: query
        maximum: 1000
        minimum: 1
        name: limit
        type: integer
      - description: Start date filter (RFC3339 format)
        example: '"2025-01-01T00:00:00Z"'
        in: query
        name: start_date
        type: string
      - description: End date filter (RFC3339 format)
        example: '"2025-12-31T23:59:59Z"'
        in: query
        name: end_date
        type: string
      - description: Filter by last N days (1-3650, alternative to start_date)
        in: query
        maximum: 3650
        minimum: 1
        name: days
        type: integer
      - description: Comma-separated list of usernames
        example: '"user1,user2"'
        in: query
        name: users
        type: string
      - description: Comma-separated list of media types
        example: '"movie,episode"'
        in: query
        name: media_types
        type: string
      - description: Comma-separated list of platforms
        example: '"Android,iOS"'
        in: query
        name: platforms
        type: string
      - description: Comma-separated list of players
        example: '"Plex for Android,Plex Web"'
        in: query
        name: players
        type: string
      - description: Comma-separated transcode decisions
        example: '"transcode,direct play"'
        in: query
        name: transcode_decisions
        type: string
      - description: Comma-separated video resolutions
        example: '"1080,720"'
        in: query
        name: video_resolutions
        type: string
      - description: Comma-separated video codecs
        example: '"h264,hevc"'
        in: query
        name: video_codecs
        type: string
      - description: Comma-separated audio codecs
        example: '"aac,ac3"'
        in: query
        name: audio_codecs
        type: string
      - description: Comma-separated library names
        example: '"Movies,TV Shows"'
        in: query
        name: libraries
        type: string
      - description: Comma-separated content ratings
        example: '"PG,PG-13,R"'
        in: query
        name: content_ratings
        type: string
      - description: Comma-separated release years
        example: '"2023,2024"'
        in: query
        name: years
        type: string
      - description: Comma-separated location types
        example: '"lan,wan"'
        in: query
        name: location_types
        type: string
      produces:
      - application/json
      responses:
        "200":
          description: Location statistics retrieved successfully
          schema:
            allOf:
            - $ref: '#/definitions/models.APIResponse'
            - properties:
                data:
                  items:
                    $ref: '#/definitions/models.LocationStats'
                  type: array
              type: object
        "400":
          description: Invalid parameters
          schema:
            $ref: '#/definitions/models.APIResponse'
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Get location statistics
      tags:
      - Core
  /media-types:
    get:
      consumes:
      - application/json
      description: Returns a list of all unique media types (movie, episode, track,
        etc.) found in playback history
      produces:
      - application/json
      responses:
        "200":
          description: List of media types retrieved successfully
          schema:
            allOf:
            - $ref: '#/definitions/models.APIResponse'
            - properties:
                data:
                  items:
                    type: string
                  type: array
              type: object
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Get list of unique media types
      tags:
      - Core
  /playbacks:
    get:
      consumes:
      - application/json
      description: Returns paginated playback event history with detailed metadata
        including user info, media details, quality metrics, and geolocation
      parameters:
      - default: 100
        description: Number of results per page (1-1000)
        in: query
        maximum: 1000
        minimum: 1
        name: limit
        type: integer
      - default: 0
        description: Number of results to skip (0-1000000)
        in: query
        maximum: 1000000
        minimum: 0
        name: offset
        type: integer
      produces:
      - application/json
      responses:
        "200":
          description: Playback events retrieved successfully
          schema:
            allOf:
            - $ref: '#/definitions/models.APIResponse'
            - properties:
                data:
                  items:
                    $ref: '#/definitions/models.PlaybackEvent'
                  type: array
              type: object
        "400":
          description: Invalid parameters
          schema:
            $ref: '#/definitions/models.APIResponse'
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Get playback history
      tags:
      - Core
  /stats:
    get:
      consumes:
      - application/json
      description: Returns overall playback statistics including total playbacks,
        unique users, unique locations, date range, and last sync time
      produces:
      - application/json
      responses:
        "200":
          description: Statistics retrieved successfully
          schema:
            allOf:
            - $ref: '#/definitions/models.APIResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.Stats'
              type: object
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Get overall statistics
      tags:
      - Core
  /sync:
    post:
      consumes:
      - application/json
      description: Manually triggers a sync with Tautulli to fetch latest playback
        data. Requires JWT authentication.
      produces:
      - application/json
      responses:
        "202":
          description: Sync triggered successfully
          schema:
            $ref: '#/definitions/models.APIResponse'
        "401":
          description: Unauthorized
          schema:
            $ref: '#/definitions/models.APIResponse'
        "409":
          description: Sync already in progress
          schema:
            $ref: '#/definitions/models.APIResponse'
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      security:
      - BearerAuth: []
      summary: Trigger data synchronization
      tags:
      - Admin
  /users:
    get:
      consumes:
      - application/json
      description: Returns a list of all unique usernames that have playback history
      produces:
      - application/json
      responses:
        "200":
          description: List of usernames retrieved successfully
          schema:
            allOf:
            - $ref: '#/definitions/models.APIResponse'
            - properties:
                data:
                  items:
                    type: string
                  type: array
              type: object
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.APIResponse'
      summary: Get list of unique users
      tags:
      - Core
  /ws:
    get:
      consumes:
      - application/json
      description: Establishes a WebSocket connection for real-time playback notifications
        and statistics updates
      produces:
      - application/json
      responses:
        "101":
          description: Switching Protocols
          schema:
            type: string
        "400":
          description: Bad Request
          schema:
            type: string
      summary: Establish WebSocket connection
      tags:
      - Realtime
schemes:
- http
- https
securityDefinitions:
  BearerAuth:
    description: JWT token stored in HTTP-only cookie. Obtain via /api/v1/auth/login
      endpoint.
    in: cookie
    name: token
    type: apiKey
    x-logo: '{"url": "https://raw.githubusercontent.com/tomtom215/cartographus/main/web/public/icons/icon.svg",
      "altText": "Cartographus Logo"}'
swagger: "2.0"
