# Reusable workflow for Go tests
name: Test

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.24.0'

jobs:
  test:
    name: Go Tests
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || 'self-hosted' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Set Go environment
        run: |
          echo "GOTOOLCHAIN=local" >> $GITHUB_ENV
          echo "CGO_ENABLED=1" >> $GITHUB_ENV

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Install DuckDB extensions
        run: |
          mkdir -p ~/.duckdb/extensions
          ./scripts/setup-duckdb-extensions.sh

      - name: Run tests with gotestsum
        run: |
          mkdir -p test-results
          gotestsum \
            --format pkgname-and-test-fails \
            --junitfile test-results/junit.xml \
            --jsonfile test-results/test-output.json \
            --rerun-fails=2 \
            --rerun-fails-max-failures=10 \
            --packages="./..." \
            -- \
            -tags "wal,nats" \
            -race \
            -coverprofile=coverage.out \
            -covermode=atomic \
            -timeout=10m

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
          retention-days: 7

      - name: Publish test report
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: 'test-results/junit.xml'
          check_name: 'Go Test Results'
          fail_on_failure: true
          require_tests: true
          detailed_summary: true
          include_passed: false

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          # Warn if coverage drops below 70%
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "::warning::Coverage is below 70%: ${COVERAGE}%"
          fi

      - name: Generate coverage badge data
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "COVERAGE_PCT=${COVERAGE}" >> $GITHUB_ENV
          echo "Coverage: ${COVERAGE}%"
