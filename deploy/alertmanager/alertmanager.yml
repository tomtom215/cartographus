# Cartographus - Media Server Analytics and Geographic Visualization
# Copyright 2026 Tom F. (tomtom215)
# SPDX-License-Identifier: AGPL-3.0-or-later
# https://github.com/tomtom215/cartographus
# Alertmanager configuration for Cartographus
# https://prometheus.io/docs/alerting/latest/configuration/
#
# This configuration provides templates for common notification channels.
# Uncomment and configure the receivers you want to use.

global:
  # How long to wait before sending a notification again if it has already
  # been sent successfully for an alert.
  resolve_timeout: 5m

  # SMTP configuration (for email notifications)
  # smtp_smarthost: 'smtp.example.com:587'
  # smtp_from: 'alertmanager@cartographus.local'
  # smtp_auth_username: 'alertmanager'
  # smtp_auth_password: 'password'
  # smtp_require_tls: true

  # Slack configuration
  # slack_api_url: '<your-slack-webhook-url>'

# The root route on which each incoming alert enters.
route:
  # The root route must not have any matchers as it is the entry point for
  # all alerts. It needs to have a receiver configured.
  receiver: 'default-receiver'

  # The labels by which incoming alerts are grouped together.
  group_by: ['alertname', 'severity', 'instance']

  # How long to initially wait to send a notification for a group of alerts.
  group_wait: 30s

  # How long to wait before sending a notification about new alerts that
  # are added to a group of alerts for which an initial notification has
  # already been sent.
  group_interval: 5m

  # How long to wait before sending a notification again if it has already
  # been sent successfully for an alert.
  repeat_interval: 4h

  # Child routes for different severity levels
  routes:
    # Critical alerts - send immediately
    - receiver: 'critical-receiver'
      matchers:
        - severity = critical
      group_wait: 10s
      repeat_interval: 1h

    # Warning alerts - can wait a bit
    - receiver: 'warning-receiver'
      matchers:
        - severity = warning
      group_wait: 1m
      repeat_interval: 4h

    # Info alerts - batch them
    - receiver: 'info-receiver'
      matchers:
        - severity = info
      group_wait: 5m
      repeat_interval: 24h

    # Security alerts - always notify
    - receiver: 'security-receiver'
      matchers:
        - alertname =~ ".*Detected|.*Attack|.*BruteForce"
      group_wait: 0s
      repeat_interval: 30m

# Inhibition rules allow to mute a set of alerts given that another alert is firing.
inhibit_rules:
  # If CartographusDown is firing, inhibit all other alerts for that instance
  - source_matchers:
      - alertname = CartographusDown
    target_matchers:
      - severity =~ "warning|info"
    equal: ['instance']

  # Critical errors inhibit warnings
  - source_matchers:
      - severity = critical
    target_matchers:
      - severity = warning
    equal: ['alertname']

# Receivers define notification integrations
receivers:
  # Default receiver - logs to stdout (useful for debugging)
  - name: 'default-receiver'
    # webhook_configs:
    #   - url: 'http://localhost:5001/webhook'

  # Critical alerts receiver
  - name: 'critical-receiver'
    # Uncomment and configure your preferred notification channel:

    # Discord webhook
    # webhook_configs:
    #   - url: '${DISCORD_WEBHOOK_URL}'
    #     send_resolved: true
    #     http_config:
    #       follow_redirects: true

    # Slack
    # slack_configs:
    #   - channel: '#alerts-critical'
    #     send_resolved: true
    #     title: '{{ template "slack.title" . }}'
    #     text: '{{ template "slack.text" . }}'
    #     color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

    # Email
    # email_configs:
    #   - to: 'oncall@example.com'
    #     send_resolved: true
    #     headers:
    #       Subject: '[CRITICAL] Cartographus Alert: {{ .GroupLabels.alertname }}'

    # PagerDuty
    # pagerduty_configs:
    #   - service_key: '${PAGERDUTY_SERVICE_KEY}'
    #     severity: critical

    # Telegram
    # telegram_configs:
    #   - bot_token: '${TELEGRAM_BOT_TOKEN}'
    #     chat_id: ${TELEGRAM_CHAT_ID}
    #     parse_mode: 'HTML'
    #     message: '{{ template "telegram.message" . }}'

  # Warning alerts receiver
  - name: 'warning-receiver'
    # slack_configs:
    #   - channel: '#alerts-warning'
    #     send_resolved: true
    #     color: 'warning'

  # Info alerts receiver
  - name: 'info-receiver'
    # slack_configs:
    #   - channel: '#alerts-info'
    #     send_resolved: false

  # Security alerts receiver (high priority)
  - name: 'security-receiver'
    # webhook_configs:
    #   - url: '${SECURITY_WEBHOOK_URL}'
    #     send_resolved: true
    # pagerduty_configs:
    #   - service_key: '${PAGERDUTY_SECURITY_KEY}'
    #     severity: critical

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'
