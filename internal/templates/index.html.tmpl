<!DOCTYPE html>

<!--
  Cartographus - Media Server Analytics and Geographic Visualization
  Copyright 2026 Tom F. (tomtom215)
  SPDX-License-Identifier: AGPL-3.0-or-later
  https://github.com/tomtom215/cartographus
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Geographic visualization for Plex Media Server playback activity via Tautulli">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="author" content="Cartographus">
    <meta name="keywords" content="Tautulli, Plex, Maps, Geographic, Visualization, Analytics, Media Server">
    <title>Cartographus - Geographic Playback Visualization</title>

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Cartographus - Geographic Playback Visualization">
    <meta property="og:description" content="Interactive maps and analytics for Plex Media Server playback activity via Tautulli. Visualize where your content is being watched worldwide.">
    <meta property="og:image" content="/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Cartographus - Geographic visualization of Plex playback">
    <meta property="og:url" content="">
    <meta property="og:site_name" content="Cartographus">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Cartographus - Geographic Playback Visualization">
    <meta name="twitter:description" content="Interactive maps and analytics for Plex Media Server playback activity via Tautulli.">
    <meta name="twitter:image" content="/og-image.png">
    <meta name="twitter:image:alt" content="Cartographus - Geographic visualization of Plex playback">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <!-- Note: Run scripts/generate-icons.sh to create PNG icons and favicon.ico from SVG source -->
    <link rel="icon" href="/favicon.ico" sizes="32x32">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cartographus">

    <!-- Resource Hints for Performance -->
    <!-- Preconnect to critical third-party origins -->
    <link rel="preconnect" href="https://a.basemaps.cartocdn.com" crossorigin>
    <link rel="preconnect" href="https://b.basemaps.cartocdn.com" crossorigin>
    <link rel="preconnect" href="https://c.basemaps.cartocdn.com" crossorigin>
    <link rel="preconnect" href="https://nominatim.openstreetmap.org" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>

    <!-- DNS prefetch for map tile servers (fallback for older browsers) -->
    <link rel="dns-prefetch" href="https://a.basemaps.cartocdn.com">
    <link rel="dns-prefetch" href="https://b.basemaps.cartocdn.com">
    <link rel="dns-prefetch" href="https://c.basemaps.cartocdn.com">
    <link rel="dns-prefetch" href="https://nominatim.openstreetmap.org">

    <!-- Critical CSS - Inline for fastest first paint -->
    <!-- Critical CSS contains only above-the-fold styles (~4KB minified) -->
    <link rel="stylesheet" href="critical.css">

    <!-- Preload full stylesheets (async loading below) -->
    <link rel="preload" href="styles.css" as="style">
    <link rel="preload" href="https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.css" as="style">

    <!-- Preload Critical Resources -->
    <link rel="preload" href="/icon.svg" as="image" type="image/svg+xml">

    <!-- Preload critical fonts (if any are used - commented for reference) -->
    <!-- <link rel="preload" href="/fonts/inter-var.woff2" as="font" type="font/woff2" crossorigin> -->

    <!-- Prefetch likely-needed resources (loaded after critical path) -->
    <!-- Main application entry point - use modulepreload for ES modules -->
    <link rel="modulepreload" href="/index.js">

    <!-- Prefetch secondary routes/features that user will likely visit -->
    <!-- Note: Heavy chunks are lazy-loaded by the app, no need to prefetch -->

    <!-- Async load full stylesheets (non-blocking) -->
    <!-- Uses media="print" trick: loads async, then switches to media="all" via JS -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.css" media="print" class="async-css">
    <link rel="stylesheet" href="styles.css" media="print" class="async-css">
    <!-- Fallback for browsers with JS disabled -->
    <noscript>
        <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.css">
        <link rel="stylesheet" href="styles.css">
    </noscript>

    <!-- WebGL Support Detection + Async CSS Loading (CSP-compliant) -->
    <script nonce="{{.Nonce}}">
        // Detect WebGL support before page load
        window.webglSupported = (function() {
            try {
                var canvas = document.createElement('canvas');
                return !!(window.WebGLRenderingContext &&
                    (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
            } catch(e) {
                return false;
            }
        })();
        // CSP-compliant async CSS loading (replaces inline onload handlers)
        document.querySelectorAll('link.async-css').forEach(function(link) {
            link.addEventListener('load', function() { this.media = 'all'; });
        });
    </script>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div id="login-container">
        <div id="login-box">
            <!-- Login Branding -->
            <div class="login-logo" aria-hidden="true">
                <svg viewBox="0 0 100 120" width="80" height="96">
                    <g transform="translate(50, 40)">
                        <circle cx="0" cy="0" r="30" fill="var(--highlight)" stroke="var(--text-primary)" stroke-width="4"/>
                        <path d="M 0,24 L 12,60 L -12,60 Z" fill="var(--highlight)" stroke="var(--text-primary)" stroke-width="2" stroke-linejoin="round"/>
                        <circle cx="0" cy="0" r="12" fill="var(--text-primary)"/>
                    </g>
                </svg>
            </div>
            <h1 class="login-title">Cartographus</h1>
            <p class="login-subtitle">Geographic playback visualization</p>

            <div id="login-error" class="error-message"></div>

            <form id="login-form">
                <div class="form-group">
                    <label class="form-label" for="username">Username</label>
                    <input
                        type="text"
                        id="username"
                        name="username"
                        class="form-input"
                        autocomplete="username"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        class="form-input"
                        autocomplete="current-password"
                        required
                    >
                </div>

                <div class="checkbox-group">
                    <input
                        type="checkbox"
                        id="remember-me"
                        name="remember_me"
                        class="form-checkbox"
                    >
                    <label for="remember-me">Remember me for 30 days</label>
                </div>

                <button type="submit" class="btn-login" id="btn-login">
                    Sign In
                </button>
            </form>

            <div class="login-divider">
                <span>or</span>
            </div>

            <button type="button" class="btn-plex-oauth" id="btn-plex-oauth">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                </svg>
                Login with Plex
            </button>
        </div>
    </div>

    <div id="app" class="hidden">
        <!-- Global Progress Bar -->
        <div id="global-progress-bar"
             class="global-progress-bar hidden"
             role="progressbar"
             aria-valuemin="0"
             aria-valuemax="100"
             aria-valuenow="0"
             aria-label="Loading progress">
            <div class="progress-fill"></div>
        </div>

        <!-- Stale Data Warning -->
        <div id="stale-data-warning"
             class="stale-data-warning hidden"
             role="alert"
             aria-live="polite">
            <span class="stale-warning-icon" aria-hidden="true">&#9888;</span>
            <span class="stale-warning-text">Data may be outdated. Last updated <span id="stale-data-time">--</span>.</span>
            <button type="button" class="stale-warning-refresh" data-action="refresh" aria-label="Refresh data now">
                Refresh Now
            </button>
            <button type="button" class="stale-warning-dismiss" data-action="dismiss" aria-label="Dismiss stale data warning">
                &times;
            </button>
        </div>

        <!-- Mobile Hamburger Menu Button -->
        <button id="menu-toggle" class="menu-toggle" aria-label="Toggle sidebar menu" aria-expanded="false" aria-controls="sidebar">
            <span></span>
        </button>

        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>

        <div id="sidebar">
            <div id="header">
                <div id="header-top">
                    <div class="header-title-group">
                        <h1>Cartographus</h1>
                        <!-- WebSocket Connection Status Indicator -->
                        <div id="ws-status"
                             class="ws-status"
                             data-testid="ws-status"
                             data-status="connecting"
                             role="status"
                             aria-live="polite"
                             aria-label="WebSocket connection: connecting"
                             title="WebSocket: Connecting..."
                             tabindex="0">
                            <span class="ws-status-dot"></span>
                            <span class="ws-status-text">Connecting</span>
                        </div>
                        <!-- Data Quality Indicator -->
                        <div id="data-quality-indicator"
                             class="data-quality-indicator hidden"
                             role="status"
                             aria-live="polite"
                             aria-label="Data quality status">
                            <div id="data-quality-status" class="data-quality-status status-healthy" aria-label="System status: checking">
                                <span class="status-dot" aria-hidden="true"></span>
                                <span class="status-text">Checking</span>
                            </div>
                            <span id="data-quality-sync-time" class="data-quality-sync-time">--</span>
                            <div id="data-quality-connection" class="data-quality-connection">
                                <span class="connection-db" title="Database" aria-label="Database: checking">DB</span>
                                <span class="connection-tautulli" title="Tautulli" aria-label="Tautulli: checking">T</span>
                            </div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <!-- Sidebar Collapse Toggle -->
                        <button id="sidebar-collapse" class="sidebar-collapse-toggle" aria-label="Collapse sidebar" title="Collapse sidebar" aria-expanded="true">
                            <span id="collapse-icon">‚óÄ</span>
                        </button>
                        <button id="colorblind-toggle" class="colorblind-toggle" data-testid="colorblind-toggle" aria-label="Toggle colorblind-safe mode" title="Toggle colorblind-safe mode">
                            <span id="colorblind-icon">üëÅÔ∏è</span>
                        </button>
                        <button id="theme-toggle" aria-label="Switch to light mode" title="Switch to light mode">
                            <span id="theme-icon">‚òÄÔ∏è</span>
                        </button>
                        <button id="settings-button" aria-label="Open settings" title="Settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </button>
                        <button id="recommendation-button" aria-label="Open recommendations" title="Recommendations">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                        </button>
                        <button id="help-docs-btn" aria-label="Open help documentation" title="Help & Documentation (Press H)">
                            <span class="help-icon" aria-hidden="true">&#x1F4D6;</span> Docs
                        </button>
                        <button id="help-tour-btn" aria-label="Start tour guide" title="Tour Guide">
                            <span>&#x2753;</span> Tour
                        </button>
                        <!-- Notification Center Toggle -->
                        <button id="notification-center-toggle"
                                class="notification-toggle-btn"
                                aria-label="Notifications (0 unread)"
                                aria-expanded="false"
                                aria-haspopup="dialog"
                                title="View notifications">
                            <span class="notification-icon" aria-hidden="true">&#x1F514;</span>
                        </button>
                        <button id="btn-logout" aria-label="Logout from application">Logout</button>
                    </div>
                </div>
                <p>Geographic playback visualization</p>
            </div>

            <nav id="nav-tabs" role="tablist" aria-label="Main navigation" data-testid="nav-tabs">
                <button class="nav-tab active" data-view="maps" data-testid="nav-tab-maps" role="tab" aria-selected="true" aria-controls="map-container" tabindex="0" id="tab-maps">
                    üó∫Ô∏è Maps
                </button>
                <button class="nav-tab" data-view="activity" data-testid="nav-tab-activity" role="tab" aria-selected="false" aria-controls="activity-container" tabindex="-1" id="tab-activity">
                    üì° Live Activity
                </button>
                <button class="nav-tab" data-view="analytics" data-testid="nav-tab-analytics" role="tab" aria-selected="false" aria-controls="analytics-container" tabindex="-1" id="tab-analytics">
                    üìä Analytics
                </button>
                <button class="nav-tab" data-view="recently-added" data-testid="nav-tab-recently-added" role="tab" aria-selected="false" aria-controls="recently-added-container" tabindex="-1" id="tab-recently-added">
                    ‚ú® Recently Added
                </button>
                <button class="nav-tab" data-view="server" data-testid="nav-tab-server" role="tab" aria-selected="false" aria-controls="server-container" tabindex="-1" id="tab-server">
                    üñ•Ô∏è Server
                </button>
                <button class="nav-tab" data-view="cross-platform" data-testid="nav-tab-cross-platform" role="tab" aria-selected="false" aria-controls="cross-platform-container" tabindex="-1" id="tab-cross-platform">
                    üîó Cross-Platform
                </button>
                <button class="nav-tab" data-view="data-governance" data-testid="nav-tab-data-governance" role="tab" aria-selected="false" aria-controls="data-governance-container" tabindex="-1" id="tab-data-governance">
                    Data Governance
                </button>
                <button class="nav-tab" data-view="newsletter" data-testid="nav-tab-newsletter" role="tab" aria-selected="false" aria-controls="newsletter-container" tabindex="-1" id="tab-newsletter">
                    Newsletters
                </button>
            </nav>

            <div id="stats">
                <div class="stat-grid" data-testid="stat-grid">
                    <div class="stat-card" data-testid="stat-card-playbacks">
                        <div class="stat-label">Total Playbacks</div>
                        <div class="stat-value-row">
                            <div class="stat-value" id="stat-playbacks" aria-live="polite" aria-atomic="true">-</div>
                            <div class="stat-trend" id="stat-playbacks-trend" data-testid="stat-trend" data-direction="neutral" aria-label="No change" title="vs last 7 days">
                                <span class="trend-arrow">-</span>
                                <span class="stat-trend-value">0%</span>
                            </div>
                        </div>
                        <!-- Mini sparkline showing trend -->
                        <div class="stat-sparkline" id="sparkline-playbacks" role="img" aria-label="Playback trend"></div>
                    </div>
                    <div class="stat-card" data-testid="stat-card-locations">
                        <div class="stat-label">Locations</div>
                        <div class="stat-value-row">
                            <div class="stat-value" id="stat-locations" aria-live="polite" aria-atomic="true">-</div>
                            <div class="stat-trend" id="stat-locations-trend" data-testid="stat-trend" data-direction="neutral" aria-label="No change" title="vs last 7 days">
                                <span class="trend-arrow">-</span>
                                <span class="stat-trend-value">0%</span>
                            </div>
                        </div>
                        <!-- Mini sparkline showing trend -->
                        <div class="stat-sparkline" id="sparkline-locations" role="img" aria-label="Location trend"></div>
                    </div>
                    <div class="stat-card" data-testid="stat-card-users">
                        <div class="stat-label">Users</div>
                        <div class="stat-value-row">
                            <div class="stat-value" id="stat-users" aria-live="polite" aria-atomic="true">-</div>
                            <div class="stat-trend" id="stat-users-trend" data-testid="stat-trend" data-direction="neutral" aria-label="No change" title="vs last 7 days">
                                <span class="trend-arrow">-</span>
                                <span class="stat-trend-value">0%</span>
                            </div>
                        </div>
                        <!-- Mini sparkline showing trend -->
                        <div class="stat-sparkline" id="sparkline-users" role="img" aria-label="User trend"></div>
                    </div>
                    <div class="stat-card" data-testid="stat-card-recent">
                        <div class="stat-label">Recent (24h)</div>
                        <div class="stat-value-row">
                            <div class="stat-value" id="stat-recent" aria-live="polite" aria-atomic="true">-</div>
                            <div class="stat-trend" id="stat-recent-trend" data-testid="stat-trend" data-direction="neutral" aria-label="No change" title="vs yesterday">
                                <span class="trend-arrow">-</span>
                                <span class="stat-trend-value">0%</span>
                            </div>
                        </div>
                        <!-- Mini sparkline showing trend -->
                        <div class="stat-sparkline" id="sparkline-recent" role="img" aria-label="Recent activity trend"></div>
                    </div>
                </div>
            </div>

            <!-- Automated Insights Panel -->
            <div id="insights-panel" class="insights-panel" data-testid="insights-panel" role="region" aria-label="Automated Insights">
                <div class="insights-header" id="insights-header">
                    <h3 class="panel-title">Insights</h3>
                </div>
                <div class="insights-loading">
                    <div class="loading-spinner"></div>
                    <span>Analyzing data...</span>
                </div>
            </div>

            <!-- Plex Transcode Monitoring Panel (Phase 1.2: v1.40) -->
            <div id="transcode-panel" class="transcode-panel hidden">
                <div class="transcode-header">
                    <h3>üé¨ Active Transcodes</h3>
                    <span id="transcode-count-badge" class="badge badge-info">0</span>
                </div>
                <div id="transcode-sessions-list" class="transcode-sessions">
                    <p class="transcode-empty-message">No active transcodes</p>
                </div>
            </div>

            <!-- Buffer Health Monitoring Panel (Phase 2.1: v1.41) -->
            <div id="buffer-health-panel" class="buffer-health-panel hidden">
                <div class="buffer-health-header">
                    <h3>üìä Buffer Health</h3>
                    <div class="buffer-health-badges">
                        <span id="buffer-critical-badge" class="badge badge-error">0</span>
                        <span id="buffer-risky-badge" class="badge badge-warning">0</span>
                    </div>
                </div>
                <div id="buffer-health-sessions-list" class="buffer-health-sessions">
                    <p class="buffer-health-empty-message">All sessions healthy</p>
                </div>
            </div>

            <div id="filters" class="filters-panel">
                <!-- Filter Panel Header -->
                <div class="filters-header">
                    <h3 class="filters-title">Filters</h3>
                    <button
                        id="filters-collapse-btn"
                        type="button"
                        class="filters-collapse-btn"
                        aria-expanded="true"
                        aria-controls="filters-content"
                        aria-label="Collapse filters panel"
                        title="Collapse filters">
                        <span class="filters-collapse-icon" aria-hidden="true">&#x25B2;</span>
                    </button>
                </div>

                <div id="filters-content" class="filters-content">
                    <!-- Filter Announcer for Screen Readers -->
                    <div id="filter-announcer" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

                    <!-- Active Filter Badges/Chips -->
                <div id="filter-badges"
                     class="filter-badges-container"
                     role="region"
                     aria-label="Active filters"
                     aria-live="polite">
                    <span class="filter-badges-placeholder visually-hidden" aria-hidden="true">No active filters</span>
                    <!-- Filter badges are dynamically inserted here -->
                </div>

                <!-- Filter Presets -->
                <div class="filter-presets-section">
                    <div class="filter-presets-header">
                        <label class="filter-label">Saved Presets</label>
                        <button id="btn-save-preset"
                                type="button"
                                class="btn-save-preset"
                                aria-label="Save current filters as preset">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Save
                        </button>
                    </div>
                    <div id="preset-list" class="preset-list" role="list" aria-label="Saved filter presets">
                        <div id="preset-list-empty" class="preset-empty-state">
                            No saved presets
                        </div>
                        <!-- Preset items are dynamically inserted here -->
                    </div>
                </div>

                <!-- Quick Date Picker Buttons -->
                <div class="filter-group" id="quick-date-buttons" role="group" aria-label="Quick date selection">
                    <label class="filter-label">Quick Select</label>
                    <div class="quick-date-buttons">
                        <button id="quick-date-today" type="button" class="quick-date-btn" aria-label="Set date to Today">Today</button>
                        <button id="quick-date-yesterday" type="button" class="quick-date-btn" aria-label="Set date to Yesterday">Yesterday</button>
                        <button id="quick-date-week" type="button" class="quick-date-btn" aria-label="Set date range to This Week">This Week</button>
                        <button id="quick-date-month" type="button" class="quick-date-btn" aria-label="Set date range to This Month">This Month</button>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Time Range Preset</label>
                    <select id="filter-days">
                        <option value="">Custom range</option>
                        <option value="1">Last 24 hours</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90" selected>Last 90 days</option>
                        <option value="365">Last year</option>
                        <option value="3650">All time</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Custom Start Date</label>
                    <input type="date" id="filter-start-date" class="form-input">
                </div>

                <div class="filter-group">
                    <label class="filter-label">Custom End Date</label>
                    <input type="date" id="filter-end-date" class="form-input">
                </div>

                <div class="filter-group">
                    <label class="filter-label">User</label>
                    <select id="filter-users">
                        <option value="">All Users</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Media Type</label>
                    <select id="filter-media-types">
                        <option value="">All Media Types</option>
                    </select>
                </div>

                <div class="filter-group">
                    <button id="btn-clear-filters" class="btn-secondary">Clear Filters</button>
                </div>

                <div class="filter-group">
                    <button id="btn-refresh">
                        <span id="refresh-icon" class="refresh-icon">&#8635;</span>
                        <span id="refresh-text">Refresh Data</span>
                    </button>
                    <!-- Data Refresh Indicator -->
                    <div id="data-refresh-indicator" class="data-refresh-indicator" role="status" aria-live="polite" style="display: none;">
                        <span class="refresh-spinner"></span>
                        <span id="refresh-status-text">Loading data...</span>
                    </div>
                </div>

                <!-- Auto-Refresh Toggle -->
                <div class="filter-group auto-refresh-group">
                    <label class="filter-label" for="auto-refresh-toggle">Auto-Refresh</label>
                    <div class="auto-refresh-control">
                        <input type="checkbox"
                               id="auto-refresh-toggle"
                               class="auto-refresh-toggle"
                               aria-label="Enable automatic data refresh every 60 seconds"
                               checked>
                        <label for="auto-refresh-toggle" class="auto-refresh-toggle-label">
                            <span class="toggle-track"></span>
                            <span class="toggle-thumb"></span>
                        </label>
                        <span class="auto-refresh-interval" id="refresh-interval-display">60s</span>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Export Data</label>
                    <button id="btn-export-csv" class="btn-export">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 2v8M4 6l4 4 4-4M2 14h12"/>
                        </svg>
                        Export Playbacks (CSV)
                    </button>
                    <button id="btn-export-geojson" class="btn-export">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 2v8M4 6l4 4 4-4M2 14h12"/>
                        </svg>
                        Export Locations (GeoJSON)
                    </button>
                    <!-- GeoParquet Export -->
                    <button id="btn-export-geoparquet" class="btn-export btn-export-advanced" title="Export locations in GeoParquet format for GIS analysis">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 2v8M4 6l4 4 4-4M2 14h12"/>
                        </svg>
                        Export (GeoParquet)
                    </button>
                </div>
                </div> <!-- Close filters-content -->
            </div>
        </div>

        <!-- Main Content Area - wraps all dashboard view containers -->
        <main id="main-content" role="main">

        <!-- Maps Dashboard (2D/3D Map Visualization) -->
        <div id="map-container" class="dashboard-view" role="tabpanel" aria-labelledby="tab-maps" tabindex="-1">
            <div id="view-toggle-control" role="group" aria-label="View mode">
                <button
                    id="view-mode-2d"
                    class="view-mode-btn active"
                    aria-pressed="true"
                    title="2D Map View">
                    üó∫Ô∏è 2D Map
                </button>
                <button
                    id="view-mode-3d"
                    class="view-mode-btn"
                    aria-pressed="false"
                    title="3D Globe View">
                    üåç 3D Globe
                </button>
            </div>

            <div id="map" role="application" aria-label="Interactive geographic map">
                <div id="webgl-not-supported" class="error-message" style="display: none;">
                    <h2>WebGL Not Supported</h2>
                    <p>Your browser doesn't support WebGL, which is required for the interactive map visualization.</p>
                    <p>Please try one of these modern browsers:</p>
                    <ul>
                        <li>Google Chrome (version 90+)</li>
                        <li>Mozilla Firefox (version 88+)</li>
                        <li>Microsoft Edge (version 90+)</li>
                        <li>Safari (version 14+)</li>
                    </ul>
                    <p>You can still view analytics charts in the Analytics tab.</p>
                </div>
                <div id="map-mode-control" role="group" aria-label="Map visualization mode">
                    <button
                        id="map-mode-points"
                        class="map-mode-btn"
                        aria-pressed="false"
                        title="Show individual points">
                        Points
                    </button>
                    <button
                        id="map-mode-clusters"
                        class="map-mode-btn"
                        aria-pressed="false"
                        title="Show clustered locations">
                        Clusters
                    </button>
                    <button
                        id="map-mode-heatmap"
                        class="map-mode-btn active"
                        aria-pressed="true"
                        title="Show heatmap density">
                        Heatmap
                    </button>
                    <button
                        id="map-mode-hexagons"
                        class="map-mode-btn"
                        data-mode="hexagons"
                        aria-pressed="false"
                        aria-label="Show hexagon density (H3 grid)"
                        title="Show H3 hexagon grid density">
                        Hexagons
                    </button>
                </div>
                <!-- H3 Hexagon Resolution Control -->
                <div id="hexagon-resolution-control" class="hexagon-resolution-control" style="display: none;">
                    <label class="filter-label" for="hexagon-resolution">Resolution</label>
                    <select id="hexagon-resolution" data-control="h3-resolution" class="h3-resolution-control">
                        <option value="6">Country (Low)</option>
                        <option value="7" selected>City (Medium)</option>
                        <option value="8">Neighborhood (High)</option>
                    </select>
                </div>
                <!-- Arc Overlay Control -->
                <div id="arc-control" class="arc-control" role="group" aria-label="Connection arc overlay">
                    <button
                        id="arc-toggle"
                        class="arc-toggle-btn"
                        data-control="arcs"
                        aria-pressed="false"
                        aria-label="Show server-to-user connection arcs"
                        title="Show connection arcs from server to users">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                            <path d="M3 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm12 12a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM2 3c.5 0 1 .2 1.4.5C5 5 6 7 8 8c2 1 5 2 5.6 2.5.4.3.4.5.4 1"/>
                            <path d="M2 3Q6 5 8 8Q10 11 14 13" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        </svg>
                        Arcs
                    </button>
                </div>
                <div id="loading" role="status" aria-live="polite">Loading...</div>
            </div>

            <div id="globe"
                role="application"
                aria-label="Interactive 3D globe visualization showing playback locations worldwide"
                aria-describedby="globe-description globe-keyboard-help"
                aria-busy="false"
                tabindex="0"
                style="display: none;">
                <!-- Screen reader description -->
                <div id="globe-description" class="sr-only">
                    Interactive 3D globe displaying media playback locations. Use arrow keys to pan, plus and minus to zoom, R to reset view. Tab to navigate controls.
                </div>
                <!-- Keyboard help (hidden but available for screen readers) -->
                <div id="globe-keyboard-help" class="sr-only">
                    Keyboard shortcuts: Arrow keys to pan the view. Plus or equals key to zoom in. Minus key to zoom out. R to reset view. Escape to exit focus.
                </div>
                <!-- Live region for announcements -->
                <div id="globe-announcer" role="status" aria-live="polite" aria-atomic="true" class="sr-only"></div>
                <!-- Data summary for screen readers -->
                <div id="globe-data-summary" role="status" aria-live="polite" class="sr-only"></div>

                <div id="globe-not-supported" class="error-message" role="alert" style="display: none;">
                    <h2>WebGL Required</h2>
                    <p>The 3D Globe requires WebGL support, which is not available in your browser.</p>
                    <p>Please switch to 2D Map view or upgrade to a modern browser:</p>
                    <ul>
                        <li>Google Chrome (version 90+)</li>
                        <li>Mozilla Firefox (version 88+)</li>
                        <li>Microsoft Edge (version 90+)</li>
                        <li>Safari (version 14+)</li>
                    </ul>
                </div>
                <div id="globe-controls" role="toolbar" aria-label="Globe view controls">
                    <button
                        id="globe-auto-rotate"
                        class="globe-control-btn"
                        title="Toggle auto-rotation (press Space to toggle)"
                        aria-label="Toggle auto-rotation"
                        aria-pressed="false">
                        <span aria-hidden="true">üîÑ</span> Auto-Rotate
                    </button>
                    <button
                        id="globe-reset-view"
                        class="globe-control-btn"
                        title="Reset camera view (press R)"
                        aria-label="Reset camera view to default position">
                        <span aria-hidden="true">üéØ</span> Reset View
                    </button>
                </div>
                <div id="globe-loading" role="status" aria-live="polite" aria-busy="true">Loading globe...</div>
            </div>

            <!-- ROOT CAUSE FIX: Moved fullscreen toggle outside #map and #globe containers -->
            <!-- WHY: When switching to globe view, #map is hidden (display:none), which also hid -->
            <!-- the fullscreen toggle inside it. Moving it to #map-container level ensures visibility -->
            <!-- in both 2D and 3D views. (E2E test: 30-fullscreen-mode.spec.ts:183) -->
            <button
                id="fullscreen-toggle"
                class="fullscreen-toggle-btn"
                aria-label="Enter fullscreen mode"
                title="Toggle fullscreen mode">
                <span class="fullscreen-icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 6V2h4M16 6V2h-4M2 12v4h4M16 12v4h-4"/>
                    </svg>
                </span>
            </button>

            <div id="timeline-container" role="region" aria-label="Playback timeline">
                <div id="timeline-header">
                    <div id="timeline-info">
                        <span id="timeline-time">--:--:--</span>
                        <span id="timeline-count">0 playbacks</span>
                    </div>
                    <div id="timeline-controls">
                        <button id="timeline-reset" aria-label="Reset timeline" title="Reset to start">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                        </button>
                        <button id="timeline-play-pause" aria-label="Play timeline" title="Play/Pause">
                            <svg id="timeline-play-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/>
                            </svg>
                            <svg id="timeline-pause-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display:none;">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M5 6.25a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0v-3.5zm3.5 0a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0v-3.5z"/>
                            </svg>
                        </button>
                        <select id="timeline-speed" aria-label="Playback speed">
                            <option value="1" selected>1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10">10x</option>
                        </select>
                        <select id="timeline-interval" aria-label="Time interval">
                            <option value="hourly" selected>Hourly</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                </div>
                <div id="timeline-scrubber">
                    <input
                        type="range"
                        id="timeline-slider"
                        min="0"
                        max="100"
                        value="0"
                        step="0.1"
                        aria-label="Timeline scrubber"
                    />
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard Container -->
        <div id="analytics-container" class="dashboard-view" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics" tabindex="-1">
            <!-- Analytics Loading Overlay -->
            <div id="analytics-loading-overlay" class="analytics-loading-overlay" role="status" aria-live="polite">
                <div class="analytics-loading-spinner"></div>
                <div class="analytics-loading-text">Loading analytics...</div>
            </div>

            <!-- Analytics Sub-Navigation (wrapped for scroll indicators) -->
            <div class="analytics-nav-wrapper" id="analytics-nav-wrapper">
                <nav id="analytics-nav" role="tablist" aria-label="Analytics sections">
                    <button class="analytics-tab active" data-analytics-page="overview" role="tab" aria-selected="true" aria-controls="analytics-overview" tabindex="0" id="tab-analytics-overview">
                        Overview
                    </button>
                    <button class="analytics-tab" data-analytics-page="content" role="tab" aria-selected="false" aria-controls="analytics-content" tabindex="-1" id="tab-analytics-content">
                        Content
                    </button>
                    <button class="analytics-tab" data-analytics-page="users" role="tab" aria-selected="false" aria-controls="analytics-users" tabindex="-1" id="tab-analytics-users">
                        Users
                    </button>
                    <button class="analytics-tab" data-analytics-page="performance" role="tab" aria-selected="false" aria-controls="analytics-performance" tabindex="-1" id="tab-analytics-performance">
                        Performance
                    </button>
                    <button class="analytics-tab" data-analytics-page="geographic" role="tab" aria-selected="false" aria-controls="analytics-geographic" tabindex="-1" id="tab-analytics-geographic">
                        Geographic
                    </button>
                    <button class="analytics-tab" data-analytics-page="advanced" role="tab" aria-selected="false" aria-controls="analytics-advanced" tabindex="-1" id="tab-analytics-advanced">
                        Advanced
                    </button>
                    <button class="analytics-tab" data-analytics-page="library" role="tab" aria-selected="false" aria-controls="analytics-library" tabindex="-1" id="tab-analytics-library">
                        Library
                    </button>
                    <button class="analytics-tab" data-analytics-page="users-profile" role="tab" aria-selected="false" aria-controls="analytics-users-profile" tabindex="-1" id="tab-analytics-users-profile">
                        User Profile
                    </button>
                    <button class="analytics-tab" data-analytics-page="tautulli" role="tab" aria-selected="false" aria-controls="analytics-tautulli" tabindex="-1" id="tab-analytics-tautulli">
                        Tautulli Data
                    </button>
                    <button class="analytics-tab" data-analytics-page="wrapped" role="tab" aria-selected="false" aria-controls="analytics-wrapped" tabindex="-1" id="tab-analytics-wrapped">
                        Wrapped
                    </button>
                </nav>
            </div>

            <!-- Overview Page -->
            <div id="analytics-overview" class="analytics-page active" role="tabpanel" aria-labelledby="tab-analytics-overview" tabindex="0">
                <h2>Overview</h2>
                <p class="page-description">Quick insights and key metrics at a glance</p>

                <!-- Quick Insights Row -->
                <div class="quick-insights-row" role="region" aria-label="Quick insights">
                    <!-- Binge Watching Quick Insight -->
                    <div class="quick-insight-card" id="binge-insight-card" aria-label="Binge Watching Summary">
                        <div class="quick-insight-header">
                            <span class="quick-insight-icon" aria-hidden="true">&#x1F4FA;</span>
                            <span class="quick-insight-title">Binge Watching</span>
                            <a href="#analytics-users" class="quick-insight-link" data-navigate-analytics="users" aria-label="View full binge analytics">View More</a>
                        </div>
                        <div class="quick-insight-metrics">
                            <div class="quick-insight-metric">
                                <span class="metric-value" id="binge-sessions-count">--</span>
                                <span class="metric-label">Binge Sessions</span>
                            </div>
                            <div class="quick-insight-metric">
                                <span class="metric-value" id="binge-avg-episodes">--</span>
                                <span class="metric-label">Avg Episodes</span>
                            </div>
                            <div class="quick-insight-metric">
                                <span class="metric-value" id="binge-top-show">--</span>
                                <span class="metric-label">Top Show</span>
                            </div>
                        </div>
                    </div>

                    <!-- Watch Party Quick Insight -->
                    <div class="quick-insight-card" id="watch-party-insight-card" aria-label="Watch Party Summary">
                        <div class="quick-insight-header">
                            <span class="quick-insight-icon" aria-hidden="true">&#x1F91D;</span>
                            <span class="quick-insight-title">Watch Parties</span>
                            <a href="#analytics-users" class="quick-insight-link" data-navigate-analytics="users" aria-label="View full watch party analytics">View More</a>
                        </div>
                        <div class="quick-insight-metrics">
                            <div class="quick-insight-metric">
                                <span class="metric-value" id="watch-party-count">--</span>
                                <span class="metric-label">Watch Parties</span>
                            </div>
                            <div class="quick-insight-metric">
                                <span class="metric-value" id="watch-party-avg-users">--</span>
                                <span class="metric-label">Avg Viewers</span>
                            </div>
                            <div class="quick-insight-metric">
                                <span class="metric-value" id="watch-party-top-content">--</span>
                                <span class="metric-label">Top Content</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Period Comparison Row -->
                <div class="period-comparison-row" role="region" aria-label="Period comparison insights">
                    <div class="period-comparison-header">
                        <h3 class="period-comparison-title">
                            <span class="comparison-icon" aria-hidden="true">&#x1F4C8;</span>
                            vs Last Period
                        </h3>
                        <select id="comparison-period-select" class="period-select" aria-label="Select comparison period">
                            <option value="week">vs Last Week</option>
                            <option value="month">vs Last Month</option>
                            <option value="quarter">vs Last Quarter</option>
                            <option value="year">vs Last Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <!-- Custom Date Range Picker -->
                    <div id="custom-date-container" class="custom-date-container hidden" aria-hidden="true">
                        <div class="custom-date-row">
                            <div class="custom-date-field">
                                <label for="comparison-start-date" class="custom-date-label">Start Date</label>
                                <input type="date" id="comparison-start-date" class="custom-date-input" aria-describedby="custom-date-error" />
                            </div>
                            <span class="custom-date-separator" aria-hidden="true">to</span>
                            <div class="custom-date-field">
                                <label for="comparison-end-date" class="custom-date-label">End Date</label>
                                <input type="date" id="comparison-end-date" class="custom-date-input" aria-describedby="custom-date-error" />
                            </div>
                            <button type="button" id="apply-custom-comparison" class="custom-date-apply" aria-label="Apply custom date range comparison">
                                Apply
                            </button>
                        </div>
                        <div id="custom-date-error" class="custom-date-error hidden" role="alert" aria-live="polite"></div>
                        <div class="custom-date-hint">Compare selected period with the equivalent previous period</div>
                    </div>
                    <div class="period-comparison-metrics" id="period-comparison-metrics">
                        <div class="comparison-metric-card" data-metric="playbacks">
                            <div class="comparison-metric-label">Total Playbacks</div>
                            <div class="comparison-metric-value" id="comp-playbacks-value">--</div>
                            <div class="comparison-metric-change" id="comp-playbacks-change">
                                <span class="change-arrow"></span>
                                <span class="change-value">--</span>
                            </div>
                        </div>
                        <div class="comparison-metric-card" data-metric="users">
                            <div class="comparison-metric-label">Active Users</div>
                            <div class="comparison-metric-value" id="comp-users-value">--</div>
                            <div class="comparison-metric-change" id="comp-users-change">
                                <span class="change-arrow"></span>
                                <span class="change-value">--</span>
                            </div>
                        </div>
                        <div class="comparison-metric-card" data-metric="watchtime">
                            <div class="comparison-metric-label">Watch Time</div>
                            <div class="comparison-metric-value" id="comp-watchtime-value">--</div>
                            <div class="comparison-metric-change" id="comp-watchtime-change">
                                <span class="change-arrow"></span>
                                <span class="change-value">--</span>
                            </div>
                        </div>
                        <div class="comparison-metric-card" data-metric="completion">
                            <div class="comparison-metric-label">Avg Completion</div>
                            <div class="comparison-metric-value" id="comp-completion-value">--</div>
                            <div class="comparison-metric-change" id="comp-completion-change">
                                <span class="change-arrow"></span>
                                <span class="change-value">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="period-comparison-insights" id="period-comparison-insights" aria-live="polite">
                        <!-- Key insights will be populated dynamically -->
                    </div>
                </div>

                <!-- Anomaly Detection Section -->
                <div class="anomaly-detection-row" role="region" aria-label="Pattern anomalies">
                    <div class="anomaly-detection-header">
                        <h3 class="anomaly-detection-title">
                            <span class="anomaly-title-icon" aria-hidden="true">&#x1F50D;</span>
                            Unusual Patterns
                        </h3>
                        <span class="anomaly-badge" id="anomaly-count-badge" hidden></span>
                    </div>
                    <div class="anomaly-detection-content" id="anomaly-detection-content" aria-live="polite">
                        <div class="anomaly-empty">
                            <span class="anomaly-empty-icon" aria-hidden="true">&#x2714;</span>
                            <span>No unusual patterns detected</span>
                        </div>
                    </div>
                </div>

                <!-- Geographic Drill-Down Section -->
                <div id="geographic-drilldown-container" class="geo-drilldown-container" role="region" aria-label="Geographic drill-down">
                    <!-- Content populated by GeographicDrillDownManager -->
                </div>

                <!-- Chart Timeline Animation Controls -->
                <div id="chart-timeline-animation-container" class="chart-timeline-animation-container" role="region" aria-label="Chart timeline animation controls">
                    <!-- Content populated by ChartTimelineAnimationManager -->
                </div>

                <div class="chart-grid" role="region" aria-label="Overview charts">
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Playback Trends Over Time</div>
                            <button class="chart-export" data-chart="trends">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-trends" tabindex="0" aria-label="Playback Trends Over Time interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Media Type Distribution</div>
                            <button class="chart-export" data-chart="media">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-media" tabindex="0" aria-label="Media Type Distribution interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Users</div>
                            <button class="chart-export" data-chart="users">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-users" tabindex="0" aria-label="Top Users interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Viewing Hours Heatmap</div>
                            <button class="chart-export" data-chart="heatmap">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-heatmap" tabindex="0" aria-label="Viewing Hours Heatmap interactive chart" style="height: 320px;"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Platform Distribution</div>
                            <button class="chart-export" data-chart="platforms">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-platforms" tabindex="0" aria-label="Platform Distribution interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Player Distribution</div>
                            <button class="chart-export" data-chart="players">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-players" tabindex="0" aria-label="Player Distribution interactive chart"></div>
                    </div>
                </div>
            </div>

            <!-- Content Analytics Page -->
            <div id="analytics-content" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-content" tabindex="0">
                <h2>Content Analytics</h2>
                <p class="page-description">Library statistics and popular content insights</p>

                <!-- Content Sub-Tabs (Collections & Playlists) -->
                <nav class="sub-tabs" role="tablist" aria-label="Content view options" data-testid="content-sub-tabs">
                    <button class="sub-tab active" data-sub-tab="content-analytics" role="tab" aria-selected="true" aria-controls="content-analytics-panel" id="tab-content-analytics">
                        Analytics
                    </button>
                    <button class="sub-tab" data-sub-tab="content-collections" role="tab" aria-selected="false" aria-controls="content-collections-panel" id="tab-content-collections">
                        Collections
                    </button>
                    <button class="sub-tab" data-sub-tab="content-playlists" role="tab" aria-selected="false" aria-controls="content-playlists-panel" id="tab-content-playlists">
                        Playlists
                    </button>
                </nav>

                <!-- Analytics Tab Panel (existing content) -->
                <div id="content-analytics-panel" class="sub-tab-panel active" role="tabpanel" aria-labelledby="tab-content-analytics" data-testid="content-analytics-panel">
                    <div class="chart-grid" role="region" aria-label="Content analytics charts">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Library Distribution</div>
                            <button class="chart-export" data-chart="libraries">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-libraries" tabindex="0" aria-label="Library Distribution interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Content Rating Distribution</div>
                            <button class="chart-export" data-chart="ratings">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-ratings" tabindex="0" aria-label="Content Rating Distribution interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Duration Statistics by Media Type</div>
                            <button class="chart-export" data-chart="duration">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-duration" tabindex="0" aria-label="Duration Statistics by Media Type interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Release Years</div>
                            <button class="chart-export" data-chart="years">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-years" tabindex="0" aria-label="Top Release Years interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Codec Combination Distribution</div>
                            <button class="chart-export" data-chart="codec">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-codec" tabindex="0" aria-label="Codec Combination Distribution interactive chart"></div>
                    </div>

                    <h3 class="section-header">Popular Content</h3>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Movies</div>
                            <button class="chart-export" data-chart="popular-movies">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-popular-movies" tabindex="0" aria-label="Top Movies interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top TV Shows</div>
                            <button class="chart-export" data-chart="popular-shows">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-popular-shows" tabindex="0" aria-label="Top TV Shows interactive chart"></div>
                    </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Top Episodes</div>
                                <button class="chart-export" data-chart="popular-episodes">Export PNG</button>
                            </div>
                            <div class="chart-content" id="chart-popular-episodes" tabindex="0" aria-label="Top Episodes interactive chart"></div>
                        </div>
                    </div>
                </div>

                <!-- Collections Tab Panel (Collections Browser) -->
                <div id="content-collections-panel" class="sub-tab-panel" role="tabpanel" aria-labelledby="tab-content-collections" data-testid="content-collections-panel" style="display: none;">
                    <!-- Library filter for collections (optional - collections can be per-library) -->
                    <div class="library-filter-container" style="margin-bottom: 20px; padding: 15px; background: #1e1e2e; border-radius: 8px;">
                        <label for="collections-library-filter" style="margin-right: 10px; font-weight: 500;">Filter by Library:</label>
                        <select id="collections-library-filter" aria-label="Filter collections by library" style="background: #2a2a3e; color: #e0e0e0; border: 1px solid #3a3a4e; padding: 8px 15px; border-radius: 4px; min-width: 200px;">
                            <option value="">All Libraries</option>
                        </select>
                    </div>
                    <!-- Container for LibraryContentManager (collections mode) -->
                    <div id="collections-container" data-testid="collections-container">
                        <div class="loading-state" style="text-align: center; padding: 40px; color: #9ca3af;">
                            Loading collections...
                        </div>
                    </div>
                </div>

                <!-- Playlists Tab Panel (Playlists Browser) -->
                <div id="content-playlists-panel" class="sub-tab-panel" role="tabpanel" aria-labelledby="tab-content-playlists" data-testid="content-playlists-panel" style="display: none;">
                    <!-- Container for LibraryContentManager (playlists mode) -->
                    <div id="playlists-container" data-testid="playlists-container">
                        <div class="loading-state" style="text-align: center; padding: 40px; color: #9ca3af;">
                            Loading playlists...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users & Behavior Page -->
            <div id="analytics-users" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-users" tabindex="0">
                <h2>User Behavior</h2>
                <p class="page-description">User engagement and viewing patterns</p>

                <div class="chart-grid" role="region" aria-label="User behavior charts">
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Engagement Summary</div>
                            <button class="chart-export" data-chart="engagement-summary">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-engagement-summary" tabindex="0" aria-label="Engagement Summary interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Viewing Patterns by Hour</div>
                            <button class="chart-export" data-chart="engagement-hours">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-engagement-hours" tabindex="0" aria-label="Engagement by Hour interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Viewing Patterns by Day</div>
                            <button class="chart-export" data-chart="engagement-days">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-engagement-days" tabindex="0" aria-label="Engagement by Day interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Content Completion Analytics</div>
                            <button class="chart-export" data-chart="completion">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-completion" tabindex="0" aria-label="Content Completion Rates interactive chart"></div>
                    </div>

                    <h3 class="section-header">Binge Watching</h3>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Binge Watching Analytics</div>
                            <button class="chart-export" data-chart="binge-summary">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-binge-summary" tabindex="0" aria-label="Binge Watching Summary interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Binge Shows</div>
                            <button class="chart-export" data-chart="binge-shows">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-binge-shows" tabindex="0" aria-label="Top Binge Watched Shows interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Binge Watchers</div>
                            <button class="chart-export" data-chart="binge-users">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-binge-users" tabindex="0" aria-label="Top Binge Watchers interactive chart"></div>
                    </div>

                    <h3 class="section-header">Social Viewing</h3>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Watch Parties & Social Viewing</div>
                            <button class="chart-export" data-chart="watch-parties-summary">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-watch-parties-summary" tabindex="0" aria-label="Watch Parties Summary interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Watch Party Content</div>
                            <button class="chart-export" data-chart="watch-parties-content">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-watch-parties-content" tabindex="0" aria-label="Popular Watch Party Content interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Most Social Users</div>
                            <button class="chart-export" data-chart="watch-parties-users">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-watch-parties-users" tabindex="0" aria-label="Top Watch Party Users interactive chart"></div>
                    </div>
                </div>
            </div>

            <!-- Performance Page -->
            <div id="analytics-performance" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-performance" tabindex="0">
                <h2>Technical Performance</h2>
                <p class="page-description">Bandwidth, streaming quality, and infrastructure metrics</p>

                <div class="chart-grid" role="region" aria-label="Technical performance charts">
                    <h3 class="section-header">Bandwidth & Infrastructure</h3>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Bandwidth Usage Trends</div>
                            <button class="chart-export" data-chart="bandwidth-trends">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-bandwidth-trends" tabindex="0" aria-label="Bandwidth Trends interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Bandwidth by Transcode Decision</div>
                            <button class="chart-export" data-chart="bandwidth-transcode">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-bandwidth-transcode" tabindex="0" aria-label="Bandwidth by Transcode Decision interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Bandwidth by Resolution</div>
                            <button class="chart-export" data-chart="bandwidth-resolution">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-bandwidth-resolution" tabindex="0" aria-label="Bandwidth by Resolution interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Top Bandwidth Users</div>
                            <button class="chart-export" data-chart="bandwidth-users">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-bandwidth-users" tabindex="0" aria-label="Top Bandwidth Users interactive chart"></div>
                    </div>

                    <h3 class="section-header">Bitrate & Bandwidth Analytics (v1.42)</h3>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Bitrate Distribution</div>
                            <button class="chart-export" data-chart="bitrate-distribution">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-bitrate-distribution" tabindex="0" role="img" aria-label="Histogram showing bitrate distribution ranges for source and transcode streams"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Bandwidth Utilization Over Time</div>
                            <button class="chart-export" data-chart="bitrate-utilization">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-bitrate-utilization" tabindex="0" role="img" aria-label="Area chart showing bandwidth utilization trends over 30 days"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Bitrate by Resolution</div>
                            <button class="chart-export" data-chart="bitrate-resolution">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-bitrate-resolution" tabindex="0" role="img" aria-label="Bar chart comparing average bitrate by video resolution"></div>
                    </div>

                    <h3 class="section-header">Quality & Technical</h3>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Transcode vs Direct Play</div>
                            <button class="chart-export" data-chart="transcode">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-transcode" tabindex="0" aria-label="Transcode Decision Distribution interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Video Resolution Distribution</div>
                            <button class="chart-export" data-chart="resolution">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-resolution" tabindex="0" aria-label="Resolution Distribution interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Resolution Quality Loss Analysis</div>
                            <button class="chart-export" data-chart="resolution-mismatch">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-resolution-mismatch" tabindex="0" aria-label="Resolution Mismatch Analysis interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">HDR & Dynamic Range Distribution</div>
                            <button class="chart-export" data-chart="hdr-analytics">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-hdr-analytics" tabindex="0" aria-label="HDR Analytics interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Audio Quality Distribution</div>
                            <button class="chart-export" data-chart="audio-analytics">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-audio-analytics" tabindex="0" aria-label="Audio Analytics interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Subtitle Usage Analytics</div>
                            <button class="chart-export" data-chart="subtitle-analytics">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-subtitle-analytics" tabindex="0" aria-label="Subtitle Analytics interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Connection Security Overview</div>
                            <button class="chart-export" data-chart="connection-security">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-connection-security" tabindex="0" aria-label="Connection Security Analysis interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Concurrent Streams Analytics</div>
                            <button class="chart-export" data-chart="concurrent-streams">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-concurrent-streams" tabindex="0" aria-label="Concurrent Streams interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Pause Pattern & Engagement Analysis</div>
                            <button class="chart-export" data-chart="pause-patterns">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-pause-patterns" tabindex="0" aria-label="Pause Patterns interactive chart"></div>
                    </div>
                </div>
            </div>

            <!-- Geographic Page -->
            <div id="analytics-geographic" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-geographic" tabindex="0">
                <h2>Geographic Analytics</h2>
                <p class="page-description">Location-based playback insights</p>

                <div class="chart-grid" role="region" aria-label="Geographic analytics charts">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top 10 Countries</div>
                            <button class="chart-export" data-chart="countries">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-countries" tabindex="0" aria-label="Top Countries interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top 10 Cities</div>
                            <button class="chart-export" data-chart="cities">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-cities" tabindex="0" aria-label="Top Cities interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <p style="padding: 20px; background: #2a2a3e; border-radius: 8px; margin: 0;">
                            For interactive map visualization, visit the <strong>Maps</strong> tab.
                            <br>
                            The maps tab provides 2D and 3D globe views with timeline playback animation.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics Page -->
            <div id="analytics-advanced" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-advanced" tabindex="0">
                <h2>Advanced Analytics</h2>
                <p class="page-description">Comparative analysis and temporal patterns</p>

                <div class="chart-grid" role="region" aria-label="Advanced analytics charts">
                    <h3 class="section-header">Comparative Analytics</h3>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">
                                Period Comparison
                                <select id="comparison-type-selector" style="margin-left: 10px; background: #2a2a3e; color: #e0e0e0; border: 1px solid #3a3a4e; padding: 5px; border-radius: 4px;">
                                    <option value="week" selected>Week over Week</option>
                                    <option value="month">Month over Month</option>
                                    <option value="quarter">Quarter over Quarter</option>
                                    <option value="year">Year over Year</option>
                                </select>
                            </div>
                            <button class="chart-export" data-chart="comparative-metrics">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-comparative-metrics" tabindex="0" aria-label="Comparative Metrics interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Content Comparison</div>
                            <button class="chart-export" data-chart="comparative-content">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-comparative-content" tabindex="0" aria-label="Comparative Content Analysis interactive chart"></div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Users Comparison</div>
                            <button class="chart-export" data-chart="comparative-users">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-comparative-users" tabindex="0" aria-label="Comparative User Analysis interactive chart"></div>
                    </div>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Key Insights</div>
                        </div>
                        <div class="chart-content" id="comparative-insights" style="padding: 20px;">
                            <ul id="insights-list" style="list-style: none; padding: 0; margin: 0;"></ul>
                        </div>
                    </div>

                    <h3 class="section-header">Temporal Geographic</h3>

                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">
                                Geographic Density Over Time
                                <select id="temporal-interval-selector" style="margin-left: 10px; background: #2a2a3e; color: #e0e0e0; border: 1px solid #3a3a4e; padding: 5px; border-radius: 4px;">
                                    <option value="hour">Hourly</option>
                                    <option value="day" selected>Daily</option>
                                    <option value="week">Weekly</option>
                                    <option value="month">Monthly</option>
                                </select>
                            </div>
                            <button class="chart-export" data-chart="temporal-heatmap">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-temporal-heatmap" tabindex="0" aria-label="Temporal Heatmap interactive chart" style="height: 600px; position: relative;">
                            <div id="temporal-map-container" style="width: 100%; height: 500px;"></div>
                            <div id="temporal-controls" style="margin-top: 10px; display: flex; align-items: center; gap: 10px; justify-content: center;">
                                <button id="temporal-play-pause" class="btn-secondary" style="padding: 8px 16px;">
                                    ‚ñ∂ Play
                                </button>
                                <button id="temporal-reset" class="btn-secondary" style="padding: 8px 16px;">
                                    ‚èÆ Reset
                                </button>
                                <input type="range" id="temporal-slider" min="0" max="100" value="0" style="flex: 1; max-width: 500px;" />
                                <span id="temporal-label" style="min-width: 150px; text-align: center;">-</span>
                                <select id="temporal-speed" style="background: #2a2a3e; color: #e0e0e0; border: 1px solid #3a3a4e; padding: 5px; border-radius: 4px;">
                                    <option value="500">0.5x</option>
                                    <option value="1000" selected>1x</option>
                                    <option value="2000">2x</option>
                                    <option value="5000">5x</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h3 class="section-header">GPU & Engagement Analytics</h3>

                    <!-- Hardware Transcode Analytics -->
                    <div class="chart-card chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Hardware Transcode Analytics</div>
                            <button class="chart-export" data-chart="hardware-transcode">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-hardware-transcode" tabindex="0" aria-label="Hardware Transcode Analytics showing GPU utilization breakdown"></div>
                    </div>

                    <!-- Abandonment Analytics -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Content Abandonment Analysis</div>
                            <button class="chart-export" data-chart="abandonment">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-abandonment" tabindex="0" aria-label="Content Abandonment Analysis showing drop-off patterns"></div>
                    </div>

                    <!-- Frame Rate Analytics -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Frame Rate Distribution</div>
                            <button class="chart-export" data-chart="frame-rate">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-frame-rate" tabindex="0" aria-label="Frame Rate Distribution showing 24/30/60fps breakdown"></div>
                    </div>

                    <!-- Container Format Analytics -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Container Format Distribution</div>
                            <button class="chart-export" data-chart="container-format">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-container-format" tabindex="0" aria-label="Container Format Distribution showing MKV, MP4, AVI usage"></div>
                    </div>

                    <!-- Hardware Transcode Trends -->
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Hardware Transcode Trends</div>
                            <button class="chart-export" data-chart="hw-transcode-trends">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-hw-transcode-trends" tabindex="0" aria-label="Hardware Transcode Trends showing historical GPU vs CPU transcoding" style="height: 350px;"></div>
                    </div>
                </div>
            </div>

            <!-- Library Deep-Dive Dashboard -->
            <div id="analytics-library" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-library" tabindex="0">
                <h2>Library Analytics</h2>
                <p class="page-description">Deep-dive analytics for individual libraries</p>

                <!-- Library Sub-Tabs (Charts vs Details view) -->
                <nav class="sub-tabs" role="tablist" aria-label="Library view options" data-testid="library-sub-tabs">
                    <button class="sub-tab active" data-sub-tab="library-charts" role="tab" aria-selected="true" aria-controls="library-charts-panel" id="tab-library-charts">
                        Charts
                    </button>
                    <button class="sub-tab" data-sub-tab="library-details" role="tab" aria-selected="false" aria-controls="library-details-panel" id="tab-library-details">
                        Details
                    </button>
                </nav>

                <!-- Charts Tab Panel (existing content) -->
                <div id="library-charts-panel" class="sub-tab-panel active" role="tabpanel" aria-labelledby="tab-library-charts" data-testid="library-charts-panel">
                    <!-- Library Selector -->
                    <div class="library-selector-container" style="margin-bottom: 20px; padding: 15px; background: #1e1e2e; border-radius: 8px;">
                    <label for="library-selector" style="margin-right: 10px; font-weight: 500;">Select Library:</label>
                    <select id="library-selector" aria-label="Select a library for detailed analytics" style="background: #2a2a3e; color: #e0e0e0; border: 1px solid #3a3a4e; padding: 8px 15px; border-radius: 4px; min-width: 200px;">
                        <option value="">-- Select a library --</option>
                    </select>
                    <span id="library-loading" style="margin-left: 15px; display: none;">Loading...</span>
                </div>

                <!-- Library Overview Stats -->
                <div id="library-overview-stats" class="library-stats" style="display: none;">
                    <div class="stats-grid" role="region" aria-label="Library statistics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Items</div>
                            <div class="stat-value" id="library-total-items">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Watched</div>
                            <div class="stat-value" id="library-watched-items">-</div>
                            <div class="stat-trend" id="library-watched-percent">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Playbacks</div>
                            <div class="stat-value" id="library-total-playbacks">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Unique Users</div>
                            <div class="stat-value" id="library-unique-users">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Watch Time</div>
                            <div class="stat-value" id="library-watch-time">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Completion</div>
                            <div class="stat-value" id="library-avg-completion">-</div>
                        </div>
                    </div>

                    <div class="most-watched" style="margin-bottom: 20px; padding: 15px; background: #1e1e2e; border-radius: 8px;">
                        <span style="color: #9ca3af;">Most Watched:</span>
                        <span id="library-most-watched" style="font-weight: 600; color: #00d4aa; margin-left: 10px;">-</span>
                    </div>
                </div>

                <div class="chart-grid" role="region" aria-label="Library analytics charts">
                    <!-- Top Users by Library -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Users in Library</div>
                            <button class="chart-export" data-chart="library-users">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-library-users" tabindex="0" aria-label="Top users in selected library showing plays and watch time"></div>
                    </div>

                    <!-- Plays by Day Trend -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Daily Playback Trend</div>
                            <button class="chart-export" data-chart="library-trend">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-library-trend" tabindex="0" aria-label="Daily playback trend for selected library"></div>
                    </div>

                    <!-- Quality Distribution -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Quality Distribution</div>
                            <button class="chart-export" data-chart="library-quality">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-library-quality" tabindex="0" aria-label="Content quality distribution showing HDR, 4K, and surround sound content"></div>
                    </div>

                    <!-- Content Health Metrics -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Content Health</div>
                        </div>
                        <div class="chart-content library-health" id="library-health-metrics" style="padding: 20px;">
                            <div class="health-metrics-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div class="health-metric">
                                    <div class="health-label" style="color: #9ca3af; font-size: 12px;">Stale Content</div>
                                    <div class="health-value" id="health-stale-content" style="font-size: 24px; font-weight: 600; color: #ff9800;">-</div>
                                    <div class="health-desc" style="font-size: 11px; color: #6b7280;">Not watched in 90 days</div>
                                </div>
                                <div class="health-metric">
                                    <div class="health-label" style="color: #9ca3af; font-size: 12px;">Popularity Score</div>
                                    <div class="health-value" id="health-popularity" style="font-size: 24px; font-weight: 600; color: #00d4aa;">-</div>
                                    <div class="health-desc" style="font-size: 11px; color: #6b7280;">Plays per item</div>
                                </div>
                                <div class="health-metric">
                                    <div class="health-label" style="color: #9ca3af; font-size: 12px;">Engagement Score</div>
                                    <div class="health-value" id="health-engagement" style="font-size: 24px; font-weight: 600; color: #3b82f6;">-</div>
                                    <div class="health-desc" style="font-size: 11px; color: #6b7280;">Avg completion rate</div>
                                </div>
                                <div class="health-metric">
                                    <div class="health-label" style="color: #9ca3af; font-size: 12px;">Growth Rate</div>
                                    <div class="health-value" id="health-growth" style="font-size: 24px; font-weight: 600;">-</div>
                                    <div class="health-desc" style="font-size: 11px; color: #6b7280;">vs previous period</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Empty state when no library selected -->
                    <div id="library-empty-state" class="empty-state" style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 18px; font-weight: 500; margin-bottom: 10px;">Select a Library</div>
                        <div>Choose a library from the dropdown above to view detailed analytics</div>
                    </div>
                </div>

                <!-- Details Tab Panel (Library Details Manager) -->
                <div id="library-details-panel" class="sub-tab-panel" role="tabpanel" aria-labelledby="tab-library-details" data-testid="library-details-panel" style="display: none;">
                    <!-- Container for LibraryDetailsManager - renders library table with drill-down -->
                    <div id="library-details-container" data-testid="library-details-container">
                        <!-- LibraryDetailsManager will render here:
                             - Library table (all libraries list)
                             - Click row -> slide-in panel with:
                               - User stats per library
                               - Media info table
                               - Watch time stats
                        -->
                        <div class="loading-state" style="text-align: center; padding: 40px; color: #9ca3af;">
                            Loading library details...
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Profile Analytics -->
            <div id="analytics-users-profile" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-users-profile" tabindex="0">
                <h2>User Profile Analytics</h2>
                <p class="page-description">Individual user viewing patterns and preferences</p>

                <!-- User Selector -->
                <div class="user-selector-container" style="margin-bottom: 20px; padding: 15px; background: #1e1e2e; border-radius: 8px;">
                    <label for="user-profile-selector" style="margin-right: 10px; font-weight: 500;">Select User:</label>
                    <select id="user-profile-selector" aria-label="Select a user for detailed profile analytics" style="background: #2a2a3e; color: #e0e0e0; border: 1px solid #3a3a4e; padding: 8px 15px; border-radius: 4px; min-width: 200px;">
                        <option value="">-- Select a user --</option>
                    </select>
                    <span id="user-profile-loading" style="margin-left: 15px; display: none;">Loading...</span>
                </div>

                <!-- User Profile Info -->
                <div id="user-profile-info" style="display: none; align-items: center; gap: 20px; margin-bottom: 20px; padding: 20px; background: #1e1e2e; border-radius: 8px;">
                    <div class="user-avatar" style="width: 60px; height: 60px; background: linear-gradient(135deg, #7c3aed, #3b82f6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
                        U
                    </div>
                    <div class="user-details" style="flex: 1;">
                        <div id="user-profile-name" style="font-size: 20px; font-weight: 600; color: #e0e0e0;"></div>
                        <div id="user-profile-username" style="font-size: 14px; color: #9ca3af;"></div>
                    </div>
                    <div id="user-profile-status" class="status-badge" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;"></div>
                    <!-- View IP History Button -->
                    <button id="btn-view-ip-history" class="action-button" data-testid="btn-view-ip-history" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; display: none;" aria-label="View IP address history for this user">
                        View IP History
                    </button>
                </div>

                <!-- User Overview Stats -->
                <div id="user-profile-stats" class="user-stats" style="display: none; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Plays</div>
                        <div class="stat-value" id="user-total-plays">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Watch Time</div>
                        <div class="stat-value" id="user-watch-time">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unique Content</div>
                        <div class="stat-value" id="user-unique-content">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Completion</div>
                        <div class="stat-value" id="user-avg-completion">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Favorite Library</div>
                        <div class="stat-value" id="user-favorite-library" style="font-size: 14px;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Favorite Platform</div>
                        <div class="stat-value" id="user-favorite-platform" style="font-size: 14px;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">First Played</div>
                        <div class="stat-value" id="user-first-played" style="font-size: 14px;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Last Played</div>
                        <div class="stat-value" id="user-last-played" style="font-size: 14px;">-</div>
                    </div>
                </div>

                <!-- User Charts -->
                <div class="chart-grid" role="region" aria-label="User profile charts" style="display: none;">
                    <!-- Activity Trend Chart -->
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Activity Trend</div>
                            <button class="chart-export" data-chart="user-activity-trend">Export PNG</button>
                        </div>
                        <div class="chart-container chart-content" id="chart-user-activity-trend" tabindex="0" aria-label="User activity trend showing plays and watch time over time"></div>
                    </div>

                    <!-- Top Content Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Content</div>
                            <button class="chart-export" data-chart="user-top-content">Export PNG</button>
                        </div>
                        <div class="chart-container chart-content" id="chart-user-top-content" tabindex="0" aria-label="User top watched content by plays and watch time"></div>
                    </div>

                    <!-- Platform Usage Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Platform Usage</div>
                            <button class="chart-export" data-chart="user-platforms">Export PNG</button>
                        </div>
                        <div class="chart-container chart-content" id="chart-user-platforms" tabindex="0" aria-label="User platform usage distribution"></div>
                    </div>
                </div>

                <!-- Empty state when no user selected -->
                <div id="user-profile-empty-state" class="empty-state" style="display: flex; flex-direction: column; align-items: center; text-align: center; padding: 60px 20px; color: #9ca3af;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üë§</div>
                    <div style="font-size: 18px; font-weight: 500; margin-bottom: 10px;">Select a User</div>
                    <div>Choose a user from the dropdown above to view their profile and activity analytics</div>
                </div>
            </div>

            <!-- Tautulli Data Analytics -->
            <div id="analytics-tautulli" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-tautulli" tabindex="0">
                <h2>Tautulli Data Analytics</h2>
                <p class="page-description">Detailed analytics from Tautulli: logins, IPs, synced items, stream types, and activity history</p>

                <!-- Tautulli Sub-Tabs (Tautulli feature views) -->
                <nav class="sub-tabs" role="tablist" aria-label="Tautulli view options" data-testid="tautulli-sub-tabs">
                    <button class="sub-tab active" data-sub-tab="tautulli-charts" role="tab" aria-selected="true" aria-controls="tautulli-charts-panel" id="tab-tautulli-charts">
                        Charts
                    </button>
                    <button class="sub-tab" data-sub-tab="metadata-deep-dive" role="tab" aria-selected="false" aria-controls="metadata-deep-dive-panel" id="tab-metadata-deep-dive">
                        Metadata
                    </button>
                    <button class="sub-tab" data-sub-tab="rating-keys" role="tab" aria-selected="false" aria-controls="rating-keys-panel" id="tab-rating-keys">
                        Rating Keys
                    </button>
                    <button class="sub-tab" data-sub-tab="search" role="tab" aria-selected="false" aria-controls="search-panel" id="tab-search">
                        Search
                    </button>
                    <button class="sub-tab" data-sub-tab="stream-data" role="tab" aria-selected="false" aria-controls="stream-data-panel" id="tab-stream-data">
                        Stream Data
                    </button>
                </nav>

                <!-- Charts Tab Panel (existing content) -->
                <div id="tautulli-charts-panel" class="sub-tab-panel active" role="tabpanel" aria-labelledby="tab-tautulli-charts" data-testid="tautulli-charts-panel">
                <div class="chart-grid" role="region" aria-label="Tautulli analytics charts">
                    <!-- User Login History -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">User Login History</div>
                            <button class="chart-export" data-chart="user-logins">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-user-logins" tabindex="0" aria-label="User login history showing success and failure breakdown"></div>
                    </div>

                    <!-- User IP Addresses -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">User IP Addresses</div>
                            <button class="chart-export" data-chart="user-ips">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-user-ips" tabindex="0" aria-label="User IP addresses showing usage patterns"></div>
                    </div>

                    <!-- Synced Items Dashboard -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Synced Items by User</div>
                            <button class="chart-export" data-chart="synced-items">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-synced-items" tabindex="0" aria-label="Synced items showing offline download status by user"></div>
                    </div>

                    <!-- Stream Type by Platform -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Stream Type by Platform</div>
                            <button class="chart-export" data-chart="stream-type-platform">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-stream-type-platform" tabindex="0" aria-label="Stream type breakdown by platform showing direct play vs transcode"></div>
                    </div>

                    <!-- Activity History Timeline -->
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Activity History Timeline</div>
                            <button class="chart-export" data-chart="activity-history">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-activity-history" tabindex="0" aria-label="Activity history timeline showing recent playback activity" style="height: 350px;"></div>
                    </div>

                    <!-- Plays Per Month -->
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Plays Per Month</div>
                            <button class="chart-export" data-chart="plays-per-month">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-plays-per-month" tabindex="0" aria-label="Monthly playback statistics by media type" style="height: 350px;"></div>
                    </div>

                    <!-- Concurrent Streams by Type -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Concurrent Streams by Type</div>
                            <button class="chart-export" data-chart="concurrent-streams-type">Export PNG</button>
                        </div>
                        <div class="chart-content" id="chart-concurrent-streams-type" tabindex="0" aria-label="Concurrent stream distribution by transcode decision"></div>
                    </div>
                </div>
                </div>

                <!-- Metadata Deep-Dive Tab Panel (Metadata Deep-Dive Manager) -->
                <div id="metadata-deep-dive-panel" class="sub-tab-panel" role="tabpanel" aria-labelledby="tab-metadata-deep-dive" data-testid="metadata-deep-dive-panel" style="display: none;">
                    <!-- Container for MetadataDeepDiveManager - renders metadata lookup and display -->
                    <div id="metadata-deep-dive-container" data-testid="metadata-deep-dive">
                        <!-- MetadataDeepDiveManager will render here:
                             - Rating key input field
                             - Metadata fetch button
                             - Basic info, ratings, summary, credits, categories, media info sections
                        -->
                    </div>
                </div>

                <!-- Rating Keys Tab Panel (Rating Keys Manager) -->
                <div id="rating-keys-panel" class="sub-tab-panel" role="tabpanel" aria-labelledby="tab-rating-keys" data-testid="rating-keys-panel" style="display: none;">
                    <!-- Container for RatingKeysManager - tracks library changes via rating key mappings -->
                    <!-- NOTE: data-testid="rating-keys-manager" is set by RatingKeysManager.ts when it renders -->
                    <div id="rating-keys-container">
                        <!-- RatingKeysManager will render here:
                             - Rating key lookup input
                             - New/Old rating key toggle
                             - Results table with mappings
                        -->
                    </div>
                </div>

                <!-- Search Tab Panel (Search Manager) -->
                <div id="search-panel" class="sub-tab-panel" role="tabpanel" aria-labelledby="tab-search" data-testid="search-panel" style="display: none;">
                    <!-- Container for SearchManager - media library search with fuzzy matching -->
                    <div id="search-container" data-testid="search-manager">
                        <!-- SearchManager will render here:
                             - Search input with debouncing
                             - Media type filter
                             - Results grid with thumbnails
                        -->
                    </div>
                </div>

                <!-- Stream Data Tab Panel (Stream Data Manager) -->
                <div id="stream-data-panel" class="sub-tab-panel" role="tabpanel" aria-labelledby="tab-stream-data" data-testid="stream-data-panel" style="display: none;">
                    <!-- Container for StreamDataManager - detailed stream information -->
                    <div id="stream-data-container" data-testid="stream-data-manager">
                        <!-- StreamDataManager will render here:
                             - Session/Row ID input
                             - Video/Audio codec details
                             - Resolution, bitrate, transcode info
                        -->
                    </div>
                </div>
            </div>

            <!-- Annual Wrapped Reports (Spotify-style Year-in-Review) -->
            <div id="analytics-wrapped" class="analytics-page" style="display: none;" role="tabpanel" aria-labelledby="tab-analytics-wrapped" tabindex="0">
                <h2>Annual Wrapped</h2>
                <p class="page-description">Your personalized media consumption journey - Spotify Wrapped style</p>

                <!-- Controls -->
                <div class="wrapped-controls">
                    <select id="wrapped-year-select" aria-label="Select year">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                    <button id="wrapped-generate-btn" class="btn btn-primary" title="Generate reports (Admin)">Generate Reports</button>
                </div>

                <!-- Loading State -->
                <div id="wrapped-loading" class="loading-state" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading your wrapped report...</p>
                </div>

                <!-- Content Container -->
                <div id="wrapped-content">
                    <!-- Server Stats Section -->
                    <section class="wrapped-section">
                        <h3>Server Statistics</h3>
                        <div class="wrapped-stats-grid">
                            <div class="wrapped-stat-card">
                                <div class="wrapped-stat-label">Total Users</div>
                                <div class="wrapped-stat-value" id="wrapped-total-users">-</div>
                            </div>
                            <div class="wrapped-stat-card">
                                <div class="wrapped-stat-label">Total Watch Time</div>
                                <div class="wrapped-stat-value" id="wrapped-total-watch-time">-</div>
                            </div>
                            <div class="wrapped-stat-card">
                                <div class="wrapped-stat-label">Total Playbacks</div>
                                <div class="wrapped-stat-value" id="wrapped-total-playbacks">-</div>
                            </div>
                            <div class="wrapped-stat-card">
                                <div class="wrapped-stat-label">Unique Content</div>
                                <div class="wrapped-stat-value" id="wrapped-unique-content">-</div>
                            </div>
                        </div>
                        <div class="wrapped-highlights">
                            <div class="wrapped-highlight">
                                <span class="highlight-label">Top Movie:</span>
                                <span class="highlight-value" id="wrapped-top-movie">-</span>
                            </div>
                            <div class="wrapped-highlight">
                                <span class="highlight-label">Top Show:</span>
                                <span class="highlight-value" id="wrapped-top-show">-</span>
                            </div>
                            <div class="wrapped-highlight">
                                <span class="highlight-label">Top Genre:</span>
                                <span class="highlight-value" id="wrapped-top-genre">-</span>
                            </div>
                            <div class="wrapped-highlight">
                                <span class="highlight-label">Peak Month:</span>
                                <span class="highlight-value" id="wrapped-peak-month">-</span>
                            </div>
                            <div class="wrapped-highlight">
                                <span class="highlight-label">Avg Completion:</span>
                                <span class="highlight-value" id="wrapped-avg-completion">-</span>
                            </div>
                        </div>
                    </section>

                    <!-- Note: Leaderboard removed for user privacy -->
                    <!-- Individual users only see their own statistics -->

                    <!-- Personal Report Section -->
                    <section class="wrapped-section" id="wrapped-user-section">
                        <h3>Your Year in Review</h3>
                        <div id="wrapped-user-content">
                            <!-- Core Stats -->
                            <div class="wrapped-user-stats">
                                <div class="wrapped-card" data-animate="true">
                                    <div class="wrapped-card-icon">&#128249;</div>
                                    <div class="wrapped-card-value" id="wrapped-user-watch-time">-</div>
                                    <div class="wrapped-card-label">Total Watch Time</div>
                                </div>
                                <div class="wrapped-card" data-animate="true">
                                    <div class="wrapped-card-icon">&#127909;</div>
                                    <div class="wrapped-card-value" id="wrapped-user-playbacks">-</div>
                                    <div class="wrapped-card-label">Total Playbacks</div>
                                </div>
                                <div class="wrapped-card" data-animate="true">
                                    <div class="wrapped-card-icon">&#127916;</div>
                                    <div class="wrapped-card-value" id="wrapped-user-unique-content">-</div>
                                    <div class="wrapped-card-label">Unique Titles</div>
                                </div>
                                <div class="wrapped-card" data-animate="true">
                                    <div class="wrapped-card-icon">&#9989;</div>
                                    <div class="wrapped-card-value" id="wrapped-user-completion">-</div>
                                    <div class="wrapped-card-label">Completion Rate</div>
                                </div>
                            </div>

                            <!-- Activity Stats -->
                            <div class="wrapped-activity-stats">
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">Days Active:</span>
                                    <span class="mini-value" id="wrapped-user-days-active">-</span>
                                </div>
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">Longest Streak:</span>
                                    <span class="mini-value" id="wrapped-user-streak">-</span>
                                </div>
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">Binge Sessions:</span>
                                    <span class="mini-value" id="wrapped-user-binges">-</span>
                                </div>
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">Discovery Rate:</span>
                                    <span class="mini-value" id="wrapped-user-discovery">-</span>
                                </div>
                            </div>

                            <!-- Quality Stats -->
                            <div class="wrapped-quality-stats">
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">Preferred Platform:</span>
                                    <span class="mini-value" id="wrapped-user-platform">-</span>
                                </div>
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">Direct Play:</span>
                                    <span class="mini-value" id="wrapped-user-direct-play">-</span>
                                </div>
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">4K Viewing:</span>
                                    <span class="mini-value" id="wrapped-user-4k">-</span>
                                </div>
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">HDR Viewing:</span>
                                    <span class="mini-value" id="wrapped-user-hdr">-</span>
                                </div>
                            </div>

                            <!-- Top Content -->
                            <div class="wrapped-top-content">
                                <div class="wrapped-content-section">
                                    <h4>Top Movies</h4>
                                    <div id="wrapped-top-movies" class="wrapped-content-list"></div>
                                </div>
                                <div class="wrapped-content-section">
                                    <h4>Top Shows</h4>
                                    <div id="wrapped-top-shows" class="wrapped-content-list"></div>
                                </div>
                                <div class="wrapped-content-section">
                                    <h4>Top Genres</h4>
                                    <div id="wrapped-top-genres" class="wrapped-genre-list"></div>
                                </div>
                            </div>

                            <!-- Viewing Patterns -->
                            <div class="wrapped-patterns">
                                <h4>Viewing Patterns</h4>
                                <div class="wrapped-pattern-stats">
                                    <div class="wrapped-mini-stat">
                                        <span class="mini-label">Peak Hour:</span>
                                        <span class="mini-value" id="wrapped-peak-hour">-</span>
                                    </div>
                                    <div class="wrapped-mini-stat">
                                        <span class="mini-label">Peak Day:</span>
                                        <span class="mini-value" id="wrapped-peak-day">-</span>
                                    </div>
                                    <div class="wrapped-mini-stat">
                                        <span class="mini-label">Peak Month:</span>
                                        <span class="mini-value" id="wrapped-user-peak-month">-</span>
                                    </div>
                                </div>
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">First Watch:</span>
                                    <span class="mini-value" id="wrapped-first-watch">-</span>
                                </div>
                                <div class="wrapped-mini-stat">
                                    <span class="mini-label">Last Watch:</span>
                                    <span class="mini-value" id="wrapped-last-watch">-</span>
                                </div>
                                <div class="wrapped-charts">
                                    <div id="wrapped-hour-chart" class="wrapped-chart"></div>
                                    <div id="wrapped-day-chart" class="wrapped-chart"></div>
                                </div>
                            </div>

                            <!-- Timeline -->
                            <div class="wrapped-timeline">
                                <h4>Monthly Journey</h4>
                                <div id="wrapped-timeline-content" class="timeline-content"></div>
                            </div>

                            <!-- Achievements -->
                            <div class="wrapped-achievements">
                                <h4>Achievements</h4>
                                <div id="wrapped-achievements-content" class="achievements-grid"></div>
                            </div>

                            <!-- Share Card -->
                            <div class="wrapped-share">
                                <h4>Share Your Wrapped</h4>
                                <div id="wrapped-share-card" class="share-card-container"></div>
                                <div class="share-buttons">
                                    <button id="wrapped-share-btn" class="btn btn-secondary">Copy Share Link</button>
                                    <button id="wrapped-export-btn" class="btn btn-secondary">Export Image</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

            <!-- Real-Time Activity Dashboard -->
            <div id="activity-container" class="dashboard-view" style="display: none;" role="tabpanel" aria-labelledby="tab-activity" tabindex="-1">
                <h2>Live Activity</h2>
                <div id="activity-overview" class="activity-overview">
                    <div class="activity-stat-card">
                        <div class="activity-stat-label">Active Streams</div>
                        <div class="activity-stat-value" id="activity-stream-count">0</div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="activity-stat-label">Direct Play</div>
                        <div class="activity-stat-value" id="activity-direct-play">0</div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="activity-stat-label">Transcode</div>
                        <div class="activity-stat-value" id="activity-transcode">0</div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="activity-stat-label">Total Bandwidth</div>
                        <div class="activity-stat-value" id="activity-bandwidth">0 Mbps</div>
                    </div>
                </div>
                <div id="activity-sessions" class="activity-sessions">
                    <div id="activity-empty-state" class="empty-state">
                        <p>No active streams at this time</p>
                    </div>
                </div>
            </div>

            <!-- Recently Added Dashboard -->
            <div id="recently-added-container" class="dashboard-view" style="display: none;" role="tabpanel" aria-labelledby="tab-recently-added" tabindex="-1">
                <h2>Recently Added Content</h2>
                <div id="recently-added-filters" class="recently-added-filters">
                    <select id="recently-added-media-type" aria-label="Media type filter">
                        <option value="">All Media Types</option>
                        <option value="movie">Movies</option>
                        <option value="show">TV Shows</option>
                        <option value="artist">Music</option>
                    </select>
                    <select id="recently-added-library" aria-label="Library filter">
                        <option value="">All Libraries</option>
                    </select>
                    <!-- Enhanced pagination controls -->
                    <select id="recently-added-count" aria-label="Items per page">
                        <option value="10">10 items</option>
                        <option value="25" selected>25 items</option>
                        <option value="50">50 items</option>
                        <option value="100">100 items</option>
                        <option value="250">250 items</option>
                        <option value="0">Load All</option>
                    </select>
                </div>
                <div id="recently-added-grid" class="recently-added-grid">
                    <div id="recently-added-loading" class="loading-state">Loading recently added content...</div>
                </div>
                <!-- Enhanced pagination with page jump -->
                <div id="recently-added-pagination" class="pagination enhanced-pagination">
                    <button id="recently-added-first" class="pagination-btn" aria-label="Go to first page" title="First page">
                        <span aria-hidden="true">¬´¬´</span>
                    </button>
                    <button id="recently-added-prev" class="pagination-btn" aria-label="Go to previous page" title="Previous page" disabled>
                        <span aria-hidden="true">‚Üê</span> Prev
                    </button>
                    <div class="pagination-jump">
                        <label for="recently-added-page-input" class="visually-hidden">Go to page</label>
                        <input type="number" id="recently-added-page-input" min="1" value="1" aria-label="Page number">
                        <span id="recently-added-page-total">/ 1</span>
                        <button id="recently-added-go" class="pagination-btn pagination-go" aria-label="Go to page">Go</button>
                    </div>
                    <button id="recently-added-next" class="pagination-btn" aria-label="Go to next page" title="Next page">
                        Next <span aria-hidden="true">‚Üí</span>
                    </button>
                    <button id="recently-added-last" class="pagination-btn" aria-label="Go to last page" title="Last page">
                        <span aria-hidden="true">¬ª¬ª</span>
                    </button>
                    <span id="recently-added-page-info" class="pagination-info" aria-live="polite"></span>
                </div>
            </div>

            <!-- Server Health Dashboard -->
            <div id="server-container" class="dashboard-view" style="display: none;" role="tabpanel" aria-labelledby="tab-server" tabindex="-1">
                <h2>Server Information</h2>
                <div id="server-health" class="server-health">
                    <div id="plex-server-card" class="server-card plex-card">
                        <div class="server-card-header">
                            <h3>Plex Media Server</h3>
                            <span id="server-status" class="server-status">‚óè</span>
                        </div>
                        <div class="server-details">
                            <div class="server-detail-row">
                                <span class="server-detail-label">Server Name:</span>
                                <span class="server-detail-value" id="server-name">-</span>
                            </div>
                            <div class="server-detail-row">
                                <span class="server-detail-label">Version:</span>
                                <span class="server-detail-value" id="server-version">-</span>
                            </div>
                            <div class="server-detail-row">
                                <span class="server-detail-label">Platform:</span>
                                <span class="server-detail-value" id="server-platform">-</span>
                            </div>
                            <div class="server-detail-row">
                                <span class="server-detail-label">Platform Version:</span>
                                <span class="server-detail-value" id="server-platform-version">-</span>
                            </div>
                            <div class="server-detail-row">
                                <span class="server-detail-label">Machine ID:</span>
                                <span class="server-detail-value" id="server-machine-id">-</span>
                            </div>
                            <div id="server-update-available" class="server-update-notice" style="display: none;">
                                <strong>Update Available!</strong>
                                <span id="server-update-version"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup/Restore Section -->
                <div id="backup-section" class="backup-section">
                    <div class="backup-header">
                        <h3>Database Backups</h3>
                        <button id="btn-create-backup" type="button" class="btn-create-backup">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Create Backup
                        </button>
                    </div>
                    <div id="backup-stats" class="backup-stats">
                        <!-- Stats populated by BackupRestoreManager -->
                    </div>
                    <div id="backup-list" class="backup-list" role="list" aria-label="Backup list">
                        <div class="backup-empty-state">
                            <p>Loading backups...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

            <!-- Cross-Platform Dashboard -->
            <div id="cross-platform-container" class="dashboard-view" style="display: none;" role="tabpanel" aria-labelledby="tab-cross-platform" tabindex="-1">
                <!-- CrossPlatformManager will populate this container -->
            </div>

            <!-- Data Governance Dashboard -->
            <div id="data-governance-container" class="dashboard-view" style="display: none;" role="tabpanel" aria-labelledby="tab-data-governance" tabindex="-1">
                <!-- Sub-navigation for data governance sections -->
                <nav class="governance-nav" role="tablist" aria-label="Data Governance sections">
                    <button class="governance-nav-tab active" data-governance-page="overview" role="tab" aria-selected="true">Overview</button>
                    <button class="governance-nav-tab" data-governance-page="deduplication" role="tab" aria-selected="false">Deduplication</button>
                    <button class="governance-nav-tab" data-governance-page="detection" role="tab" aria-selected="false">Detection</button>
                    <button class="governance-nav-tab" data-governance-page="sync" role="tab" aria-selected="false">Sync Status</button>
                    <button class="governance-nav-tab" data-governance-page="backups" role="tab" aria-selected="false">Backups</button>
                    <button class="governance-nav-tab" data-governance-page="health" role="tab" aria-selected="false">Health</button>
                    <button class="governance-nav-tab" data-governance-page="lineage" role="tab" aria-selected="false">Data Lineage</button>
                    <button class="governance-nav-tab" data-governance-page="audit" role="tab" aria-selected="false">Audit Log</button>
                    <button class="governance-nav-tab" data-governance-page="failed" role="tab" aria-selected="false">Failed Events</button>
                </nav>

                <!-- Overview Page -->
                <div id="governance-overview-page" class="governance-page" data-page="overview">
                    <div class="governance-overview-grid">
                        <!-- Key Metrics Cards -->
                        <div class="governance-metrics-row">
                            <div class="governance-metric-card" data-metric="total-events">
                                <div class="metric-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20V10"/>
                                        <path d="M18 20V4"/>
                                        <path d="M6 20v-4"/>
                                    </svg>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="governance-total-events">--</div>
                                    <div class="metric-label">Total Events</div>
                                </div>
                            </div>
                            <div class="governance-metric-card" data-metric="dedupe-rate">
                                <div class="metric-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="8.5" cy="7" r="4"/>
                                        <path d="M20 8v6"/>
                                        <path d="M23 11h-6"/>
                                    </svg>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="governance-dedupe-rate">--</div>
                                    <div class="metric-label">Dedupe Rate</div>
                                </div>
                            </div>
                            <div class="governance-metric-card" data-metric="detection-alerts">
                                <div class="metric-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="governance-alerts-count">--</div>
                                    <div class="metric-label">Active Alerts</div>
                                </div>
                            </div>
                            <div class="governance-metric-card" data-metric="sync-health">
                                <div class="metric-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="23 4 23 10 17 10"/>
                                        <polyline points="1 20 1 14 7 14"/>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                    </svg>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="governance-sync-status">--</div>
                                    <div class="metric-label">Sync Health</div>
                                </div>
                            </div>
                            <div class="governance-metric-card" data-metric="failed-events">
                                <div class="metric-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="15" y1="9" x2="9" y2="15"/>
                                        <line x1="9" y1="9" x2="15" y2="15"/>
                                    </svg>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="governance-failed-count">--</div>
                                    <div class="metric-label">Failed Events</div>
                                </div>
                            </div>
                            <div class="governance-metric-card" data-metric="data-freshness">
                                <div class="metric-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="governance-data-freshness">--</div>
                                    <div class="metric-label">Data Freshness</div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity Timeline -->
                        <div class="governance-section">
                            <h3 class="governance-section-title">Recent Data Activity</h3>
                            <div class="governance-timeline" id="governance-activity-timeline">
                                <div class="timeline-loading">Loading activity...</div>
                            </div>
                        </div>

                        <!-- Data Sources Health -->
                        <div class="governance-section">
                            <h3 class="governance-section-title">Data Sources</h3>
                            <div class="governance-sources-grid" id="governance-sources">
                                <div class="source-loading">Loading sources...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deduplication Page -->
                <div id="governance-deduplication-page" class="governance-page" data-page="deduplication" style="display: none;">
                    <div class="governance-section-header">
                        <h3>Deduplication Audit Log</h3>
                        <div class="governance-actions">
                            <button type="button" class="btn-governance" id="dedupe-refresh-btn" aria-label="Refresh audit log">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                            <button type="button" class="btn-governance" id="dedupe-export-btn" aria-label="Export to CSV">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Dedupe Statistics -->
                    <div class="dedupe-stats-grid" id="dedupe-stats-grid">
                        <div class="dedupe-stat-card">
                            <div class="stat-value" id="dedupe-total">--</div>
                            <div class="stat-label">Total Deduplicated</div>
                        </div>
                        <div class="dedupe-stat-card">
                            <div class="stat-value" id="dedupe-pending">--</div>
                            <div class="stat-label">Pending Review</div>
                        </div>
                        <div class="dedupe-stat-card">
                            <div class="stat-value" id="dedupe-confirmed">--</div>
                            <div class="stat-label">Confirmed</div>
                        </div>
                        <div class="dedupe-stat-card">
                            <div class="stat-value" id="dedupe-restored">--</div>
                            <div class="stat-label">Restored</div>
                        </div>
                        <div class="dedupe-stat-card">
                            <div class="stat-value" id="dedupe-accuracy">--</div>
                            <div class="stat-label">Accuracy Rate</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="dedupe-filters">
                        <select id="dedupe-filter-status" class="governance-select" aria-label="Filter by status">
                            <option value="">All Statuses</option>
                            <option value="auto_dedupe">Pending Review</option>
                            <option value="user_confirmed">Confirmed</option>
                            <option value="user_restored">Restored</option>
                        </select>
                        <select id="dedupe-filter-reason" class="governance-select" aria-label="Filter by reason">
                            <option value="">All Reasons</option>
                            <option value="event_id">Event ID Match</option>
                            <option value="session_key">Session Key Match</option>
                            <option value="correlation_key">Correlation Key</option>
                            <option value="cross_source_key">Cross-Source Match</option>
                            <option value="db_constraint">DB Constraint</option>
                        </select>
                        <select id="dedupe-filter-source" class="governance-select" aria-label="Filter by source">
                            <option value="">All Sources</option>
                            <option value="tautulli">Tautulli</option>
                            <option value="plex">Plex</option>
                            <option value="jellyfin">Jellyfin</option>
                            <option value="emby">Emby</option>
                        </select>
                    </div>

                    <!-- Audit Log Table -->
                    <div class="dedupe-table-container">
                        <table class="governance-table" id="dedupe-audit-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Source</th>
                                    <th>Reason</th>
                                    <th>Layer</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dedupe-audit-tbody">
                                <tr><td colspan="7" class="table-loading">Loading audit entries...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Detection Page -->
                <div id="governance-detection-page" class="governance-page" data-page="detection" style="display: none;">
                    <div class="governance-section-header">
                        <h3>Security Detection Alerts</h3>
                        <div class="governance-actions">
                            <button type="button" class="btn-governance" id="detection-refresh-btn" aria-label="Refresh alerts">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Detection Stats -->
                    <div class="detection-stats-grid" id="detection-stats-grid">
                        <div class="detection-stat-card severity-critical">
                            <div class="stat-value" id="detection-critical">--</div>
                            <div class="stat-label">Critical</div>
                        </div>
                        <div class="detection-stat-card severity-high">
                            <div class="stat-value" id="detection-high">--</div>
                            <div class="stat-label">High</div>
                        </div>
                        <div class="detection-stat-card severity-medium">
                            <div class="stat-value" id="detection-medium">--</div>
                            <div class="stat-label">Medium</div>
                        </div>
                        <div class="detection-stat-card severity-low">
                            <div class="stat-value" id="detection-low">--</div>
                            <div class="stat-label">Low</div>
                        </div>
                    </div>

                    <!-- Alerts Table -->
                    <div class="detection-table-container">
                        <table class="governance-table" id="detection-alerts-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>User</th>
                                    <th>Severity</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="detection-alerts-tbody">
                                <tr><td colspan="7" class="table-loading">Loading alerts...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Detection Rules -->
                    <div class="governance-section">
                        <h4>Detection Rules Configuration</h4>
                        <div class="detection-rules-grid" id="detection-rules-grid">
                            <div class="rules-loading">Loading rules...</div>
                        </div>
                    </div>
                </div>

                <!-- Sync Status Page -->
                <div id="governance-sync-page" class="governance-page" data-page="sync" style="display: none;">
                    <div class="governance-section-header">
                        <h3>Sync Status &amp; Event Pipeline</h3>
                        <div class="governance-actions">
                            <button type="button" class="btn-governance" id="sync-refresh-btn" aria-label="Refresh sync status">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Sync Sources Status -->
                    <div class="sync-sources-grid" id="sync-sources-grid">
                        <div class="sync-source-card">
                            <div class="source-header">
                                <span class="source-name">Tautulli</span>
                                <span class="source-status" id="sync-tautulli-status">--</span>
                            </div>
                            <div class="source-details">
                                <div class="source-stat">
                                    <span class="stat-label">Last Sync</span>
                                    <span class="stat-value" id="sync-tautulli-last">--</span>
                                </div>
                                <div class="source-stat">
                                    <span class="stat-label">Events Today</span>
                                    <span class="stat-value" id="sync-tautulli-events">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="sync-source-card">
                            <div class="source-header">
                                <span class="source-name">Plex</span>
                                <span class="source-status" id="sync-plex-status">--</span>
                            </div>
                            <div class="source-details">
                                <div class="source-stat">
                                    <span class="stat-label">Last Sync</span>
                                    <span class="stat-value" id="sync-plex-last">--</span>
                                </div>
                                <div class="source-stat">
                                    <span class="stat-label">Events Today</span>
                                    <span class="stat-value" id="sync-plex-events">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="sync-source-card">
                            <div class="source-header">
                                <span class="source-name">Jellyfin</span>
                                <span class="source-status" id="sync-jellyfin-status">--</span>
                            </div>
                            <div class="source-details">
                                <div class="source-stat">
                                    <span class="stat-label">Last Sync</span>
                                    <span class="stat-value" id="sync-jellyfin-last">--</span>
                                </div>
                                <div class="source-stat">
                                    <span class="stat-label">Events Today</span>
                                    <span class="stat-value" id="sync-jellyfin-events">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="sync-source-card">
                            <div class="source-header">
                                <span class="source-name">Emby</span>
                                <span class="source-status" id="sync-emby-status">--</span>
                            </div>
                            <div class="source-details">
                                <div class="source-stat">
                                    <span class="stat-label">Last Sync</span>
                                    <span class="stat-value" id="sync-emby-last">--</span>
                                </div>
                                <div class="source-stat">
                                    <span class="stat-label">Events Today</span>
                                    <span class="stat-value" id="sync-emby-events">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Event Pipeline Stats -->
                    <div class="governance-section">
                        <h4>Event Pipeline Metrics</h4>
                        <div class="pipeline-metrics-grid" id="pipeline-metrics">
                            <div class="pipeline-metric">
                                <div class="metric-value" id="pipeline-received">--</div>
                                <div class="metric-label">Events Received</div>
                            </div>
                            <div class="pipeline-metric">
                                <div class="metric-value" id="pipeline-processed">--</div>
                                <div class="metric-label">Events Processed</div>
                            </div>
                            <div class="pipeline-metric">
                                <div class="metric-value" id="pipeline-deduplicated">--</div>
                                <div class="metric-label">Deduplicated</div>
                            </div>
                            <div class="pipeline-metric">
                                <div class="metric-value" id="pipeline-failed">--</div>
                                <div class="metric-label">Failed</div>
                            </div>
                            <div class="pipeline-metric">
                                <div class="metric-value" id="pipeline-latency">--</div>
                                <div class="metric-label">Avg Latency</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backups Page -->
                <div id="governance-backups-page" class="governance-page" data-page="backups" style="display: none;">
                    <div class="governance-section-header">
                        <h3>Backup History &amp; Management</h3>
                        <div class="governance-actions">
                            <button type="button" class="btn-governance" id="backups-refresh-btn" aria-label="Refresh backup list">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                            <button type="button" class="btn-governance btn-primary" id="backups-create-btn" aria-label="Create new backup">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Create Backup
                            </button>
                        </div>
                    </div>

                    <!-- Backup Statistics -->
                    <div class="backup-stats-grid" id="backup-stats-grid">
                        <div class="backup-stat-card">
                            <div class="stat-value" id="backup-total-count">--</div>
                            <div class="stat-label">Total Backups</div>
                        </div>
                        <div class="backup-stat-card">
                            <div class="stat-value" id="backup-total-size">--</div>
                            <div class="stat-label">Total Size</div>
                        </div>
                        <div class="backup-stat-card">
                            <div class="stat-value" id="backup-full-count">--</div>
                            <div class="stat-label">Full Backups</div>
                        </div>
                        <div class="backup-stat-card">
                            <div class="stat-value" id="backup-db-count">--</div>
                            <div class="stat-label">DB Backups</div>
                        </div>
                        <div class="backup-stat-card">
                            <div class="stat-value" id="backup-config-count">--</div>
                            <div class="stat-label">Config Backups</div>
                        </div>
                        <div class="backup-stat-card">
                            <div class="stat-value" id="backup-last-backup">--</div>
                            <div class="stat-label">Last Backup</div>
                        </div>
                    </div>

                    <!-- Backup Schedule Configuration -->
                    <div class="governance-section backup-schedule-section">
                        <h4>Automatic Backup Schedule</h4>
                        <div class="schedule-config-container">
                            <div class="schedule-status">
                                <div class="schedule-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="schedule-enabled" aria-label="Enable scheduled backups">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Enable Scheduled Backups</span>
                                </div>
                                <div class="schedule-next" id="schedule-next-backup">
                                    <span class="next-label">Next backup:</span>
                                    <span class="next-value" id="schedule-next-value">--</span>
                                </div>
                            </div>
                            <div class="schedule-config-grid" id="schedule-config-grid">
                                <div class="schedule-config-item">
                                    <label for="schedule-interval">Backup Interval</label>
                                    <select id="schedule-interval" class="governance-select">
                                        <option value="1">Every hour</option>
                                        <option value="6">Every 6 hours</option>
                                        <option value="12">Every 12 hours</option>
                                        <option value="24" selected>Daily</option>
                                        <option value="168">Weekly</option>
                                    </select>
                                </div>
                                <div class="schedule-config-item">
                                    <label for="schedule-preferred-hour">Preferred Time (Hour)</label>
                                    <select id="schedule-preferred-hour" class="governance-select">
                                        <option value="0">12:00 AM</option>
                                        <option value="1">1:00 AM</option>
                                        <option value="2" selected>2:00 AM</option>
                                        <option value="3">3:00 AM</option>
                                        <option value="4">4:00 AM</option>
                                        <option value="5">5:00 AM</option>
                                        <option value="6">6:00 AM</option>
                                        <option value="12">12:00 PM</option>
                                        <option value="18">6:00 PM</option>
                                        <option value="22">10:00 PM</option>
                                        <option value="23">11:00 PM</option>
                                    </select>
                                </div>
                                <div class="schedule-config-item">
                                    <label for="schedule-backup-type">Backup Type</label>
                                    <select id="schedule-backup-type" class="governance-select">
                                        <option value="full" selected>Full Backup</option>
                                        <option value="database">Database Only</option>
                                        <option value="config">Config Only</option>
                                    </select>
                                </div>
                                <div class="schedule-config-item">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="schedule-pre-sync" aria-label="Create backup before sync">
                                        <span>Backup before sync</span>
                                    </label>
                                </div>
                            </div>
                            <div class="schedule-actions">
                                <button type="button" class="btn-governance btn-small btn-primary" id="schedule-save-btn">Save Schedule</button>
                                <button type="button" class="btn-governance btn-small" id="schedule-trigger-btn">Run Backup Now</button>
                            </div>
                        </div>
                    </div>

                    <!-- Retention Policy Info -->
                    <div class="governance-section backup-retention-section">
                        <h4>Retention Policy</h4>
                        <div class="retention-policy-grid" id="retention-policy-grid">
                            <div class="retention-item">
                                <span class="retention-label">Min Keep:</span>
                                <span class="retention-value" id="retention-min-count">--</span>
                            </div>
                            <div class="retention-item">
                                <span class="retention-label">Max Keep:</span>
                                <span class="retention-value" id="retention-max-count">--</span>
                            </div>
                            <div class="retention-item">
                                <span class="retention-label">Max Age:</span>
                                <span class="retention-value" id="retention-max-age">--</span>
                            </div>
                            <div class="retention-item">
                                <span class="retention-label">Keep Daily:</span>
                                <span class="retention-value" id="retention-daily">--</span>
                            </div>
                            <div class="retention-item">
                                <span class="retention-label">Keep Weekly:</span>
                                <span class="retention-value" id="retention-weekly">--</span>
                            </div>
                            <div class="retention-item">
                                <span class="retention-label">Keep Monthly:</span>
                                <span class="retention-value" id="retention-monthly">--</span>
                            </div>
                        </div>
                        <div class="retention-actions">
                            <button type="button" class="btn-governance btn-small" id="retention-preview-btn">Preview Cleanup</button>
                            <button type="button" class="btn-governance btn-danger btn-small" id="retention-apply-btn">Apply Retention</button>
                        </div>
                    </div>

                    <!-- Backup List Table -->
                    <div class="backup-table-container">
                        <table class="governance-table" id="backup-list-table">
                            <thead>
                                <tr>
                                    <th>Created</th>
                                    <th>Type</th>
                                    <th>Filename</th>
                                    <th>Size</th>
                                    <th>Records</th>
                                    <th>Valid</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backup-list-tbody">
                                <tr><td colspan="8" class="table-loading">Loading backups...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Health Page -->
                <div id="governance-health-page" class="governance-page" data-page="health" style="display: none;">
                    <div class="governance-section-header">
                        <h3>System Health Overview</h3>
                        <div class="governance-actions">
                            <button type="button" class="btn-governance" id="health-refresh-btn" aria-label="Refresh health status">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Overall Health Status -->
                    <div class="health-overview-card" id="health-overview-card">
                        <div class="health-status-indicator" id="health-status-indicator">
                            <div class="health-status-icon healthy">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                            </div>
                            <div class="health-status-text">
                                <span class="health-status-label" id="health-status-label">System Status</span>
                                <span class="health-status-value" id="health-status-value">--</span>
                            </div>
                        </div>
                        <div class="health-meta">
                            <div class="health-meta-item">
                                <span class="meta-label">Version:</span>
                                <span class="meta-value" id="health-version">--</span>
                            </div>
                            <div class="health-meta-item">
                                <span class="meta-label">Uptime:</span>
                                <span class="meta-value" id="health-uptime">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Component Health Grid -->
                    <div class="health-components-grid">
                        <div class="health-component-card" id="health-database">
                            <div class="component-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <ellipse cx="12" cy="5" rx="9" ry="3"/>
                                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                                </svg>
                            </div>
                            <div class="component-details">
                                <span class="component-name">Database (DuckDB)</span>
                                <span class="component-status" id="health-db-status">--</span>
                            </div>
                            <div class="component-indicator" id="health-db-indicator"></div>
                        </div>

                        <div class="health-component-card" id="health-tautulli">
                            <div class="component-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                    <line x1="8" y1="21" x2="16" y2="21"/>
                                    <line x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                            </div>
                            <div class="component-details">
                                <span class="component-name">Tautulli</span>
                                <span class="component-status" id="health-tautulli-status">--</span>
                            </div>
                            <div class="component-indicator" id="health-tautulli-indicator"></div>
                        </div>

                        <div class="health-component-card" id="health-nats">
                            <div class="component-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                </svg>
                            </div>
                            <div class="component-details">
                                <span class="component-name">NATS JetStream</span>
                                <span class="component-status" id="health-nats-status">--</span>
                            </div>
                            <div class="component-indicator" id="health-nats-indicator"></div>
                        </div>

                        <div class="health-component-card" id="health-wal">
                            <div class="component-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                </svg>
                            </div>
                            <div class="component-details">
                                <span class="component-name">Write-Ahead Log</span>
                                <span class="component-status" id="health-wal-status">--</span>
                            </div>
                            <div class="component-indicator" id="health-wal-indicator"></div>
                        </div>

                        <div class="health-component-card" id="health-websocket">
                            <div class="component-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14"/>
                                    <path d="M12 5l7 7-7 7"/>
                                </svg>
                            </div>
                            <div class="component-details">
                                <span class="component-name">WebSocket Hub</span>
                                <span class="component-status" id="health-ws-status">--</span>
                            </div>
                            <div class="component-indicator" id="health-ws-indicator"></div>
                        </div>

                        <div class="health-component-card" id="health-detection">
                            <div class="component-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                </svg>
                            </div>
                            <div class="component-details">
                                <span class="component-name">Detection Engine</span>
                                <span class="component-status" id="health-detection-status">--</span>
                            </div>
                            <div class="component-indicator" id="health-detection-indicator"></div>
                        </div>
                    </div>

                    <!-- Recent Health Events -->
                    <div class="governance-section">
                        <h4>Last Sync Times</h4>
                        <div class="health-sync-times" id="health-sync-times">
                            <div class="sync-time-item">
                                <span class="sync-source">Last Data Sync:</span>
                                <span class="sync-time" id="health-last-sync">--</span>
                            </div>
                            <div class="sync-time-item">
                                <span class="sync-source">Last Backup:</span>
                                <span class="sync-time" id="health-last-backup">--</span>
                            </div>
                            <div class="sync-time-item">
                                <span class="sync-source">Last Detection Run:</span>
                                <span class="sync-time" id="health-last-detection">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Connected Media Servers -->
                    <div class="governance-section">
                        <div class="governance-section-header" style="margin-bottom: 1rem;">
                            <h4 style="margin: 0;">Connected Media Servers</h4>
                            <div class="health-servers-summary">
                                <span class="server-count-badge connected" title="Connected">
                                    <span id="health-servers-connected">0</span> connected
                                </span>
                                <span class="server-count-badge error" title="Errors" id="health-servers-error-badge" style="display: none;">
                                    <span id="health-servers-error">0</span> errors
                                </span>
                            </div>
                        </div>
                        <div class="health-servers-grid" id="health-servers-grid">
                            <div class="health-servers-loading">Loading servers...</div>
                        </div>
                    </div>
                </div>

                <!-- Data Lineage Page -->
                <div id="governance-lineage-page" class="governance-page" data-page="lineage" style="display: none;">
                    <div class="governance-section-header">
                        <h3>Data Lineage &amp; Audit Trail</h3>
                    </div>

                    <!-- Event Lookup -->
                    <div class="lineage-lookup">
                        <label for="lineage-event-id" class="governance-label">Look up event by ID:</label>
                        <div class="lineage-search">
                            <input type="text" id="lineage-event-id" class="governance-input" placeholder="Enter event ID...">
                            <button type="button" class="btn-governance" id="lineage-lookup-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                </svg>
                                Trace
                            </button>
                        </div>
                    </div>

                    <!-- Lineage Results -->
                    <div class="lineage-results" id="lineage-results" style="display: none;">
                        <div class="lineage-event-info" id="lineage-event-info">
                            <!-- Event details will be populated here -->
                        </div>
                        <div class="lineage-timeline" id="lineage-timeline">
                            <!-- Event history timeline will be populated here -->
                        </div>
                    </div>

                    <!-- Recent Modifications -->
                    <div class="governance-section">
                        <h4>Recent Data Modifications</h4>
                        <div class="lineage-modifications" id="lineage-modifications">
                            <div class="modifications-loading">Loading recent modifications...</div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Page -->
                <div id="governance-audit-page" class="governance-page" data-page="audit" style="display: none;">
                    <div class="governance-section-header">
                        <h3>Security Audit Log</h3>
                        <div class="governance-actions">
                            <button type="button" class="btn-governance" id="audit-refresh-btn" aria-label="Refresh audit log">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                            <button type="button" class="btn-governance" id="audit-export-btn" aria-label="Export audit log">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Audit Statistics -->
                    <div class="audit-stats-grid" id="audit-stats-grid">
                        <div class="audit-stat-card">
                            <div class="stat-value" id="audit-total-events">--</div>
                            <div class="stat-label">Total Events</div>
                        </div>
                        <div class="audit-stat-card severity-critical">
                            <div class="stat-value" id="audit-critical-count">--</div>
                            <div class="stat-label">Critical</div>
                        </div>
                        <div class="audit-stat-card severity-warning">
                            <div class="stat-value" id="audit-warning-count">--</div>
                            <div class="stat-label">Warnings</div>
                        </div>
                        <div class="audit-stat-card severity-info">
                            <div class="stat-value" id="audit-info-count">--</div>
                            <div class="stat-label">Info</div>
                        </div>
                        <div class="audit-stat-card">
                            <div class="stat-value" id="audit-auth-events">--</div>
                            <div class="stat-label">Auth Events</div>
                        </div>
                        <div class="audit-stat-card">
                            <div class="stat-value" id="audit-failures">--</div>
                            <div class="stat-label">Failures</div>
                        </div>
                    </div>

                    <!-- Audit Filters -->
                    <div class="audit-filters">
                        <select class="governance-select" id="audit-type-filter">
                            <option value="">All Types</option>
                            <option value="auth.success">Auth Success</option>
                            <option value="auth.failure">Auth Failure</option>
                            <option value="auth.lockout">Lockout</option>
                            <option value="authz.denied">Access Denied</option>
                            <option value="detection.alert">Detection Alert</option>
                            <option value="config.changed">Config Changed</option>
                            <option value="data.export">Data Export</option>
                            <option value="data.backup">Backup</option>
                            <option value="admin.action">Admin Action</option>
                        </select>
                        <select class="governance-select" id="audit-severity-filter">
                            <option value="">All Severities</option>
                            <option value="critical">Critical</option>
                            <option value="error">Error</option>
                            <option value="warning">Warning</option>
                            <option value="info">Info</option>
                        </select>
                        <select class="governance-select" id="audit-outcome-filter">
                            <option value="">All Outcomes</option>
                            <option value="success">Success</option>
                            <option value="failure">Failure</option>
                        </select>
                        <input type="text" class="governance-input" id="audit-search" placeholder="Search events..." style="max-width: 200px;">
                    </div>

                    <!-- Audit Events Table -->
                    <div class="audit-table-container">
                        <table class="governance-table" id="audit-events-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Actor</th>
                                    <th>Action</th>
                                    <th>Description</th>
                                    <th>Outcome</th>
                                    <th>Source IP</th>
                                </tr>
                            </thead>
                            <tbody id="audit-events-tbody">
                                <tr><td colspan="8" class="table-loading">Loading audit events...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="audit-pagination" id="audit-pagination">
                        <button type="button" class="btn-governance btn-small" id="audit-prev-btn" disabled>Previous</button>
                        <span class="pagination-info" id="audit-page-info">Page 1</span>
                        <button type="button" class="btn-governance btn-small" id="audit-next-btn">Next</button>
                    </div>
                </div>

                <!-- Failed Events Page -->
                <div id="governance-failed-page" class="governance-page" data-page="failed" style="display: none;">
                    <div class="governance-section-header">
                        <h3>Failed Events (Dead Letter Queue)</h3>
                        <div class="governance-actions">
                            <button type="button" class="btn-governance" id="failed-refresh-btn" aria-label="Refresh failed events">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                            <button type="button" class="btn-governance btn-danger" id="failed-retry-all-btn" aria-label="Retry all failed events">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                                </svg>
                                Retry All
                            </button>
                        </div>
                    </div>

                    <!-- Failed Events Stats -->
                    <div class="failed-stats-grid" id="failed-stats-grid">
                        <div class="failed-stat-card">
                            <div class="stat-value" id="failed-total">--</div>
                            <div class="stat-label">Total Failed</div>
                        </div>
                        <div class="failed-stat-card">
                            <div class="stat-value" id="failed-pending">--</div>
                            <div class="stat-label">Pending Retry</div>
                        </div>
                        <div class="failed-stat-card">
                            <div class="stat-value" id="failed-retried">--</div>
                            <div class="stat-label">Retry Success</div>
                        </div>
                        <div class="failed-stat-card">
                            <div class="stat-value" id="failed-permanent">--</div>
                            <div class="stat-label">Permanent Failures</div>
                        </div>
                    </div>

                    <!-- Failed Events Table -->
                    <div class="failed-table-container">
                        <table class="governance-table" id="failed-events-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Source</th>
                                    <th>Reason</th>
                                    <th>Retries</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="failed-events-tbody">
                                <tr><td colspan="6" class="table-loading">Loading failed events...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Newsletter Management Container -->
            <div id="newsletter-container" class="dashboard-view" style="display: none;" role="tabpanel" aria-labelledby="tab-newsletter" tabindex="-1">
                <!-- Newsletter Navigation -->
                <nav class="newsletter-nav" role="tablist" aria-label="Newsletter sections">
                    <button class="newsletter-nav-tab active" data-newsletter-page="overview" role="tab" aria-selected="true">Overview</button>
                    <button class="newsletter-nav-tab" data-newsletter-page="templates" role="tab" aria-selected="false">Templates</button>
                    <button class="newsletter-nav-tab" data-newsletter-page="schedules" role="tab" aria-selected="false">Schedules</button>
                    <button class="newsletter-nav-tab" data-newsletter-page="deliveries" role="tab" aria-selected="false">Delivery History</button>
                </nav>

                <!-- Newsletter Overview Page -->
                <div id="newsletter-overview-page" class="newsletter-page" data-page="overview">
                    <div class="newsletter-section-header">
                        <h2>Newsletter Overview</h2>
                        <div class="newsletter-actions">
                            <button id="newsletter-overview-refresh-btn" class="btn btn-secondary" title="Refresh">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="newsletter-stats-grid">
                        <div class="newsletter-stat-card">
                            <div class="stat-value" id="newsletter-total-templates">--</div>
                            <div class="stat-label">Total Templates</div>
                            <div class="stat-sub" id="newsletter-active-templates">-- active</div>
                        </div>
                        <div class="newsletter-stat-card">
                            <div class="stat-value" id="newsletter-total-schedules">--</div>
                            <div class="stat-label">Total Schedules</div>
                            <div class="stat-sub" id="newsletter-enabled-schedules">-- enabled</div>
                        </div>
                        <div class="newsletter-stat-card">
                            <div class="stat-value" id="newsletter-total-deliveries">--</div>
                            <div class="stat-label">Total Deliveries</div>
                            <div class="stat-sub" id="newsletter-success-rate">--%</div>
                        </div>
                        <div class="newsletter-stat-card success">
                            <div class="stat-value" id="newsletter-successful-deliveries">--</div>
                            <div class="stat-label">Successful</div>
                        </div>
                        <div class="newsletter-stat-card error">
                            <div class="stat-value" id="newsletter-failed-deliveries">--</div>
                            <div class="stat-label">Failed</div>
                        </div>
                        <div class="newsletter-stat-card">
                            <div class="stat-value" id="newsletter-last-7-days">--</div>
                            <div class="stat-label">Last 7 Days</div>
                            <div class="stat-sub" id="newsletter-last-30-days">-- last 30 days</div>
                        </div>
                    </div>

                    <!-- Channel Distribution -->
                    <div class="newsletter-section">
                        <h3>Deliveries by Channel</h3>
                        <div id="newsletter-channel-distribution" class="channel-distribution">
                            <p class="empty-state">Loading...</p>
                        </div>
                    </div>

                    <!-- Recent Deliveries -->
                    <div class="newsletter-section">
                        <h3>Recent Deliveries</h3>
                        <table class="newsletter-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Schedule</th>
                                    <th>Channel</th>
                                    <th>Recipients</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="newsletter-recent-deliveries-tbody">
                                <tr><td colspan="6" class="table-loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Newsletter Templates Page -->
                <div id="newsletter-templates-page" class="newsletter-page" data-page="templates" style="display: none;">
                    <div class="newsletter-section-header">
                        <h2>Newsletter Templates</h2>
                        <div class="newsletter-actions">
                            <button id="newsletter-templates-refresh-btn" class="btn btn-secondary" title="Refresh">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                            </button>
                            <button id="newsletter-templates-create-btn" class="btn btn-primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Create Template
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="newsletter-filters">
                        <select id="newsletter-templates-type-filter" class="newsletter-select" aria-label="Filter by type">
                            <option value="">All Types</option>
                            <option value="recently_added">Recently Added</option>
                            <option value="coming_soon">Coming Soon</option>
                            <option value="weekly_digest">Weekly Digest</option>
                            <option value="monthly_recap">Monthly Recap</option>
                            <option value="watchlist_updates">Watchlist Updates</option>
                            <option value="trending_content">Trending Content</option>
                            <option value="personalized_recommendations">Personalized</option>
                        </select>
                        <select id="newsletter-templates-active-filter" class="newsletter-select" aria-label="Filter by status">
                            <option value="">All Status</option>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                        <input type="search" id="newsletter-templates-search" class="newsletter-search" placeholder="Search templates..." aria-label="Search templates">
                    </div>

                    <!-- Templates Table -->
                    <table class="newsletter-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Subject</th>
                                <th>Version</th>
                                <th>Status</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="newsletter-templates-tbody">
                            <tr><td colspan="7" class="table-loading">Loading templates...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Newsletter Schedules Page -->
                <div id="newsletter-schedules-page" class="newsletter-page" data-page="schedules" style="display: none;">
                    <div class="newsletter-section-header">
                        <h2>Newsletter Schedules</h2>
                        <div class="newsletter-actions">
                            <button id="newsletter-schedules-refresh-btn" class="btn btn-secondary" title="Refresh">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                            </button>
                            <button id="newsletter-schedules-create-btn" class="btn btn-primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Create Schedule
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="newsletter-filters">
                        <select id="newsletter-schedules-enabled-filter" class="newsletter-select" aria-label="Filter by enabled status">
                            <option value="">All Schedules</option>
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>

                    <!-- Schedules Table -->
                    <table class="newsletter-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Template</th>
                                <th>Schedule</th>
                                <th>Channels</th>
                                <th>Recipients</th>
                                <th>Enabled</th>
                                <th>Last Run</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="newsletter-schedules-tbody">
                            <tr><td colspan="8" class="table-loading">Loading schedules...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Newsletter Deliveries Page -->
                <div id="newsletter-deliveries-page" class="newsletter-page" data-page="deliveries" style="display: none;">
                    <div class="newsletter-section-header">
                        <h2>Delivery History</h2>
                        <div class="newsletter-actions">
                            <button id="newsletter-deliveries-refresh-btn" class="btn btn-secondary" title="Refresh">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="newsletter-filters">
                        <select id="newsletter-deliveries-status-filter" class="newsletter-select" aria-label="Filter by status">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="sending">Sending</option>
                            <option value="delivered">Delivered</option>
                            <option value="failed">Failed</option>
                            <option value="partial">Partial</option>
                            <option value="canceled">Canceled</option>
                        </select>
                        <select id="newsletter-deliveries-channel-filter" class="newsletter-select" aria-label="Filter by channel">
                            <option value="">All Channels</option>
                            <option value="email">Email</option>
                            <option value="discord">Discord</option>
                            <option value="slack">Slack</option>
                            <option value="telegram">Telegram</option>
                            <option value="webhook">Webhook</option>
                            <option value="in_app">In-App</option>
                        </select>
                    </div>

                    <!-- Deliveries Table -->
                    <table class="newsletter-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Schedule / Template</th>
                                <th>Channel</th>
                                <th>Status</th>
                                <th>Recipients</th>
                                <th>Duration</th>
                                <th>Content</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="newsletter-deliveries-tbody">
                            <tr><td colspan="8" class="table-loading">Loading deliveries...</td></tr>
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    <div class="newsletter-pagination">
                        <button id="newsletter-deliveries-prev-btn" class="btn btn-secondary" disabled>Previous</button>
                        <span id="newsletter-deliveries-page-info">Page 1</span>
                        <button id="newsletter-deliveries-next-btn" class="btn btn-secondary">Next</button>
                    </div>
                </div>
            </div>

        </main> <!-- Close main-content -->

    </div>

    <!-- Create Backup Dialog -->
    <div id="create-backup-dialog"
         class="backup-dialog-overlay"
         role="dialog"
         aria-modal="true"
         aria-labelledby="create-backup-dialog-title"
         aria-hidden="true"
         style="display: none;">
        <div class="backup-dialog-content">
            <h2 id="create-backup-dialog-title" class="backup-dialog-title">Create Backup</h2>
            <div class="backup-dialog-form">
                <div class="backup-form-group">
                    <label for="backup-type-select">Backup Type</label>
                    <select id="backup-type-select" class="backup-type-select">
                        <option value="full">Full Backup (Database + Config)</option>
                        <option value="database">Database Only</option>
                        <option value="config">Config Only</option>
                    </select>
                </div>
                <div class="backup-form-group">
                    <label for="backup-notes-input">Notes (optional)</label>
                    <input type="text"
                           id="backup-notes-input"
                           class="backup-notes-input"
                           placeholder="e.g., Before update"
                           maxlength="200">
                </div>
            </div>
            <div class="backup-dialog-actions">
                <button type="button" class="btn-confirm" id="btn-confirm-backup">Create Backup</button>
                <button type="button" class="btn-cancel" id="btn-cancel-backup">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Restore Backup Dialog -->
    <div id="restore-backup-dialog"
         class="backup-dialog-overlay restore-dialog"
         role="dialog"
         aria-modal="true"
         aria-labelledby="restore-backup-dialog-title"
         aria-hidden="true"
         style="display: none;">
        <div class="backup-dialog-content">
            <h2 id="restore-backup-dialog-title" class="backup-dialog-title">Restore Backup</h2>
            <p id="restore-backup-info" class="restore-backup-info">
                Restore from backup will replace your current data.
            </p>
            <div class="backup-dialog-form">
                <div class="backup-form-group">
                    <label class="restore-option">
                        <input type="checkbox" id="restore-database-checkbox" checked>
                        <span>Restore Database</span>
                    </label>
                </div>
                <div class="backup-form-group">
                    <label class="restore-option">
                        <input type="checkbox" id="restore-pre-backup-checkbox" checked>
                        <span>Create pre-restore backup</span>
                    </label>
                </div>
                <div class="backup-form-group">
                    <label class="restore-option">
                        <input type="checkbox" id="restore-verify-checkbox" checked>
                        <span>Verify after restore</span>
                    </label>
                </div>
            </div>
            <div class="backup-dialog-warning">
                <strong>Warning:</strong> This action cannot be easily undone. Make sure you have a recent backup.
            </div>
            <div class="backup-dialog-actions">
                <button type="button" class="btn-confirm btn-danger" id="btn-confirm-restore">Restore</button>
                <button type="button" class="btn-cancel" id="btn-cancel-restore">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Aria-live announcer for chart keyboard navigation and dynamic updates -->
    <div id="chart-announcer" class="visually-hidden" aria-live="assertive" aria-atomic="true"></div>

    <!-- Settings Panel Overlay -->
    <div id="settings-overlay" class="settings-overlay" style="display: none;"></div>

    <!-- Settings Panel -->
    <div id="settings-panel"
         class="settings-panel"
         role="dialog"
         aria-modal="true"
         aria-labelledby="settings-panel-title"
         aria-hidden="true"
         style="display: none;">
        <div class="settings-header">
            <h2 id="settings-panel-title">Settings</h2>
            <button class="settings-close" aria-label="Close settings" data-action="close-settings">&times;</button>
        </div>

        <div class="settings-content">
            <!-- Appearance Section -->
            <section class="settings-section">
                <h3 class="settings-section-title">Appearance</h3>

                <div class="settings-group">
                    <label class="settings-label">Theme</label>
                    <div class="theme-options">
                        <button class="theme-option" data-theme="dark" title="Dark theme">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                            <span>Dark</span>
                        </button>
                        <button class="theme-option" data-theme="light" title="Light theme">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                            <span>Light</span>
                        </button>
                        <button class="theme-option" data-theme="high-contrast" title="High contrast theme">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M12 2v20"/>
                            </svg>
                            <span>High Contrast</span>
                        </button>
                    </div>
                </div>

                <div class="settings-group">
                    <label class="settings-label" for="colorblind-settings-toggle">Colorblind Mode</label>
                    <div class="settings-toggle-row">
                        <span class="settings-description">Use colorblind-friendly color palette</span>
                        <label class="settings-toggle">
                            <input type="checkbox" id="colorblind-settings-toggle" name="colorblind-mode">
                            <span class="settings-toggle-track">
                                <span class="settings-toggle-thumb"></span>
                            </span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Map Settings Section -->
            <section class="settings-section">
                <h3 class="settings-section-title">Map</h3>

                <div class="settings-group">
                    <label class="settings-label">Default Visualization</label>
                    <div class="viz-mode-options">
                        <button class="viz-mode-option" data-viz-mode="points" title="Point markers">
                            <span>Points</span>
                        </button>
                        <button class="viz-mode-option" data-viz-mode="heatmap" title="Heatmap">
                            <span>Heatmap</span>
                        </button>
                        <button class="viz-mode-option" data-viz-mode="clusters" title="Clusters">
                            <span>Clusters</span>
                        </button>
                    </div>
                </div>

                <div class="settings-group">
                    <label class="settings-label">Default View</label>
                    <div class="view-mode-options">
                        <button class="view-mode-option" data-view-mode="2d" title="2D Map">
                            <span>2D Map</span>
                        </button>
                        <button class="view-mode-option" data-view-mode="3d" title="3D Globe">
                            <span>3D Globe</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Data Settings Section -->
            <section class="settings-section">
                <h3 class="settings-section-title">Data</h3>

                <div class="settings-group">
                    <label class="settings-label" for="auto-refresh-toggle-settings">Auto-Refresh</label>
                    <div class="settings-toggle-row">
                        <span class="settings-description">Automatically refresh data periodically</span>
                        <label class="settings-toggle">
                            <input type="checkbox" id="auto-refresh-toggle-settings" name="auto-refresh">
                            <span class="settings-toggle-track">
                                <span class="settings-toggle-thumb"></span>
                            </span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Data Management Section -->
            <section class="settings-section">
                <h3 class="settings-section-title">Data Management</h3>

                <div class="settings-actions">
                    <button type="button" class="btn-settings-action btn-export-settings" id="btn-export-settings">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Export Settings
                    </button>
                    <button type="button" class="btn-settings-action btn-import-settings" id="btn-import-settings">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Import Settings
                    </button>
                    <button type="button" class="btn-settings-action btn-clear-settings btn-danger" id="btn-clear-settings">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Clear All Settings
                    </button>
                </div>

                <!-- Hidden file input for import -->
                <input type="file" id="settings-import-input" class="settings-import" accept=".json" style="display: none;">
            </section>
        </div>
    </div>

    <!-- Recommendation Panel Overlay -->
    <div id="recommendation-overlay" class="recommendation-overlay" style="display: none;"></div>

    <!-- Recommendation Panel -->
    <div id="recommendation-panel"
         class="recommendation-panel"
         role="dialog"
         aria-modal="true"
         aria-labelledby="recommendation-panel-title"
         aria-hidden="true"
         style="display: none;">
        <div class="recommendation-header">
            <h2 id="recommendation-panel-title">Recommendations</h2>
            <div class="recommendation-header-actions">
                <button class="recommendation-refresh" aria-label="Refresh recommendations" data-action="refresh-recommendations">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                </button>
                <button class="recommendation-close" aria-label="Close recommendations" data-action="close-recommendations">&times;</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="recommendation-tabs" role="tablist" aria-label="Recommendation panel tabs">
            <button class="tab-button active" data-tab="recommendations" role="tab" aria-selected="true">
                <span class="tab-icon">&#9734;</span>
                Recommendations
            </button>
            <button class="tab-button" data-tab="whatsnext" role="tab" aria-selected="false">
                <span class="tab-icon">&#128302;</span>
                What's Next
            </button>
            <button class="tab-button" data-tab="algorithms" role="tab" aria-selected="false">
                <span class="tab-icon">&#9881;</span>
                Algorithms
            </button>
        </div>

        <div class="recommendation-content">
            <!-- ===============================================================
                 RECOMMENDATIONS TAB
                 =============================================================== -->
            <div class="recommendations-tab-content">
                <!-- Mode Selector -->
                <div class="recommendation-modes" role="tablist" aria-label="Recommendation modes">
                    <button class="recommendation-mode active" data-mode="personalized" role="tab" aria-selected="true">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        For You
                    </button>
                    <button class="recommendation-mode" data-mode="trending" role="tab" aria-selected="false">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                        Trending
                    </button>
                    <button class="recommendation-mode" data-mode="similar" role="tab" aria-selected="false">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Similar
                    </button>
                </div>

                <!-- Training Status -->
                <div class="training-status" role="status" aria-live="polite">
                    <div class="training-info">
                        <span class="training-label">Loading...</span>
                    </div>
                </div>

                <!-- Config Display -->
                <div class="recommendation-config">
                    <!-- Config info populated by JS -->
                </div>

                <!-- Recommendation Grid -->
                <div class="recommendation-grid" role="list" aria-label="Recommended content">
                    <div class="recommendation-empty">
                        <span class="empty-icon">&#128173;</span>
                        <span class="empty-text">Select a user to see recommendations</span>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="recommendation-meta" role="contentinfo">
                    <!-- Metadata populated by JS -->
                </div>
            </div>

            <!-- ===============================================================
                 WHAT'S NEXT TAB (Markov Chain Predictions)
                 =============================================================== -->
            <div class="whatsnext-tab-content" style="display: none;">
                <div class="whatsnext-header">
                    <div class="whatsnext-source">
                        <span class="whatsnext-source-label">Watch something to see predictions</span>
                    </div>
                </div>

                <div class="whatsnext-grid" role="list" aria-label="What to watch next predictions">
                    <div class="whatsnext-empty">
                        <span class="empty-icon">&#128302;</span>
                        <span class="empty-text">Watch something first to see predictions based on viewing patterns</span>
                    </div>
                </div>

                <div class="whatsnext-meta">
                    <!-- Metadata populated by JS -->
                </div>
            </div>

            <!-- ===============================================================
                 ALGORITHMS TAB (Info and Tooltips)
                 =============================================================== -->
            <div class="algorithms-tab-content" style="display: none;">
                <!-- Content populated by JS -->
            </div>
        </div>

        <!-- Training Actions -->
        <div class="recommendation-footer">
            <button class="btn-train" data-action="trigger-training">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                Retrain Models
            </button>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboard-shortcuts-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="keyboard-shortcuts-title" aria-hidden="true" style="display: none;">
        <div class="modal-content keyboard-shortcuts-content">
            <div class="modal-header">
                <h2 id="keyboard-shortcuts-title">Keyboard Shortcuts</h2>
                <button class="modal-close" aria-label="Close keyboard shortcuts modal">&times;</button>
            </div>
            <div class="modal-body">
                <section class="shortcut-section">
                    <h3>Global</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <kbd>?</kbd>
                            <span>Open this shortcuts modal</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Escape</kbd>
                            <span>Close modal or sidebar</span>
                        </div>
                    </div>
                </section>
                <section class="shortcut-section">
                    <h3>Navigation</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <kbd>Tab</kbd>
                            <span>Move focus to next element</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Shift</kbd> + <kbd>Tab</kbd>
                            <span>Move focus to previous element</span>
                        </div>
                    </div>
                </section>
                <section class="shortcut-section">
                    <h3>Analytics Pages</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <kbd>Arrow Left</kbd> / <kbd>Arrow Right</kbd>
                            <span>Navigate between analytics pages</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>1-6</kbd>
                            <span>Jump to specific analytics page</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>1</kbd> Overview <kbd>2</kbd> Content <kbd>3</kbd> Users
                        </div>
                        <div class="shortcut-item">
                            <kbd>4</kbd> Performance <kbd>5</kbd> Geographic <kbd>6</kbd> Advanced
                        </div>
                    </div>
                </section>
                <section class="shortcut-section">
                    <h3>Charts (when focused)</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <kbd>Arrow Left</kbd> / <kbd>Arrow Right</kbd>
                            <span>Navigate data points</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Home</kbd> / <kbd>End</kbd>
                            <span>Jump to first/last data point</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Enter</kbd>
                            <span>Announce current data point</span>
                        </div>
                    </div>
                </section>
                <section class="shortcut-section">
                    <h3>Onboarding Tour</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <kbd>Arrow Right</kbd>
                            <span>Next step</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Arrow Left</kbd>
                            <span>Previous step</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Escape</kbd>
                            <span>Skip tour</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- User IP History Modal -->
    <div id="user-ip-history-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="ip-history-title" aria-hidden="true" data-testid="user-ip-history-modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #3a3a4e;">
                <h2 id="ip-history-title" style="margin: 0; font-size: 18px; font-weight: 600;">IP Address History</h2>
                <button id="btn-close-ip-history" class="modal-close" aria-label="Close IP history modal" style="background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px; overflow-y: auto; max-height: calc(80vh - 80px);">
                <!-- Container for UserIPDetailsManager -->
                <div id="user-ip-details-container" data-testid="user-ip-details-container">
                    <div class="loading-state" style="text-align: center; padding: 40px; color: #9ca3af;">
                        Loading IP history...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmation-dialog"
         class="confirmation-dialog-overlay"
         role="dialog"
         aria-modal="true"
         aria-labelledby="confirmation-dialog-title"
         aria-describedby="confirmation-dialog-message"
         aria-hidden="true"
         style="display: none;">
        <div class="confirmation-dialog-content">
            <h2 id="confirmation-dialog-title" class="confirmation-dialog-title">Confirm Action</h2>
            <p id="confirmation-dialog-message" class="confirmation-dialog-message">Are you sure you want to proceed?</p>
            <div class="confirmation-dialog-actions">
                <button type="button" class="btn-confirm" id="confirmation-dialog-confirm">Confirm</button>
                <button type="button" class="btn-cancel" id="confirmation-dialog-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Error Boundary Overlay -->
    <div id="error-boundary-overlay"
         class="error-boundary-overlay"
         role="alertdialog"
         aria-modal="true"
         aria-labelledby="error-boundary-title"
         aria-describedby="error-boundary-message"
         aria-hidden="true"
         style="display: none;">
        <div class="error-boundary-content">
            <div class="error-boundary-icon" aria-hidden="true">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
            </div>
            <h2 id="error-boundary-title" class="error-boundary-title">Unable to Load Data</h2>
            <p id="error-boundary-message" class="error-boundary-message">
                We encountered a problem loading your data. Please check your connection and try again.
            </p>
            <div class="error-boundary-actions">
                <button type="button" class="btn-retry" id="error-boundary-retry">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Retry
                </button>
                <button type="button" class="btn-dismiss" id="error-boundary-dismiss">
                    Dismiss
                </button>
            </div>
            <p class="error-boundary-help">
                If the problem persists, try refreshing the page or contact your administrator.
            </p>
        </div>
    </div>

    <!-- Save Preset Dialog -->
    <div id="save-preset-dialog"
         class="save-preset-dialog-overlay"
         role="dialog"
         aria-modal="true"
         aria-labelledby="save-preset-dialog-title"
         aria-hidden="true"
         style="display: none;">
        <div class="save-preset-dialog-content">
            <h2 id="save-preset-dialog-title" class="save-preset-dialog-title">Save Filter Preset</h2>
            <div class="save-preset-form">
                <label for="preset-name-input" class="save-preset-label">Preset Name</label>
                <input type="text"
                       id="preset-name-input"
                       class="save-preset-input"
                       placeholder="Enter preset name"
                       maxlength="50"
                       autocomplete="off">
                <p class="preset-name-error" role="alert" aria-live="polite"></p>
            </div>
            <div class="save-preset-dialog-actions">
                <button type="button" class="btn-confirm" id="btn-confirm-save-preset">Save Preset</button>
                <button type="button" class="btn-cancel" id="btn-cancel-save-preset">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Application Footer -->
    <footer id="app-footer" class="app-footer" role="contentinfo">
        <div class="footer-content">
            <span class="footer-brand">Cartographus</span>
            <span class="footer-separator" aria-hidden="true">|</span>
            <span class="footer-version">v2.0.0</span>
            <span class="footer-separator" aria-hidden="true">|</span>
            <button type="button" class="footer-link" id="footer-about-link" aria-label="Open about dialog">About</button>
            <span class="footer-separator" aria-hidden="true">|</span>
            <a href="https://github.com/tomtom215/cartographus" target="_blank" rel="noopener noreferrer" class="footer-link">
                GitHub
                <span class="sr-only">(opens in new window)</span>
            </a>
        </div>
    </footer>

    <script nonce="{{.Nonce}}" type="module" src="index.js"></script>

    <!-- Service Worker Registration -->
    <script nonce="{{.Nonce}}">
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);

                        // Check for updates every hour
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
