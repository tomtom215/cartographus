"use strict";(()=>{var p="cartographus-v2",h=`${p}-static`,l=`${p}-api`,d=`${p}-images`,R=`${p}-tiles`,c={maxEntries:{api:50,images:100,tiles:200},ttl:{api:300*1e3,apiStatic:1800*1e3,images:1440*60*1e3,tiles:10080*60*1e3}},v=["/","/index.html","/index.js","/styles.css","/manifest.json","/icon.svg","/icon-192.png","/icon-512.png"],b={static:[/\/api\/v1\/users$/,/\/api\/v1\/media-types$/,/\/api\/v1\/health$/],dynamic:[/\/api\/v1\/stats$/,/\/api\/v1\/locations/,/\/api\/v1\/analytics/,/\/api\/v1\/tautulli\//]},C=["basemaps.cartocdn.com","a.basemaps.cartocdn.com","b.basemaps.cartocdn.com","c.basemaps.cartocdn.com","tile.openstreetmap.org"];self.addEventListener("install",e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(h).then(t=>(console.log("[Service Worker] Caching static assets"),t.addAll(v.map(s=>new Request(s,{cache:"reload"}))))).catch(t=>(console.error("[Service Worker] Failed to cache static assets:",t),Promise.resolve())).then(()=>(console.log("[Service Worker] Installed successfully"),self.skipWaiting())))});self.addEventListener("activate",e=>{console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then(t=>Promise.all(t.filter(s=>s.startsWith("cartographus-")&&s!==h&&s!==l&&s!==d&&s!==R).map(s=>(console.log("[Service Worker] Deleting old cache:",s),caches.delete(s))))).then(()=>(console.log("[Service Worker] Activated successfully"),self.clients.claim())))});self.addEventListener("fetch",e=>{let{request:t}=e,s=new URL(t.url);if(t.method==="GET"&&!(s.protocol==="ws:"||s.protocol==="wss:")&&s.protocol!=="chrome-extension:"){if(k(s)){e.respondWith(y(t,h));return}if(L(s)){e.respondWith(w(t,R,c.ttl.tiles));return}if(A(s)){e.respondWith(w(t,d,c.ttl.images));return}if(S(s.href)){e.respondWith(W(t,l,c.ttl.apiStatic));return}if(T(s.href)){e.respondWith(W(t,l,c.ttl.api));return}if(x(s)){e.respondWith(u(t,l));return}if(U(s)){e.respondWith(u(t,d));return}e.respondWith(u(t,h))}});async function y(e,t){try{let s=await caches.open(t),a=await s.match(e);if(a)return console.log("[Service Worker] Cache hit:",e.url),a;console.log("[Service Worker] Cache miss, fetching:",e.url);let n=await fetch(e);return n.ok&&s.put(e,n.clone()),n}catch(s){console.error("[Service Worker] Cache-first error:",s);let n=await(await caches.open(t)).match(e);return n||new Response("Offline - Unable to fetch resource",{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"text/plain"}})}}async function w(e,t,s){try{let a=await caches.open(t),n=await a.match(e);if(n){let i=n.headers.get("sw-cache-time");if(i){if(Date.now()-parseInt(i,10)<s)return n}else return n}let o=await fetch(e);if(o.ok){let i=new Response(o.body,{status:o.status,statusText:o.statusText,headers:f(o.headers)});return a.put(e,i.clone()),i}return o}catch{let o=await(await caches.open(t)).match(e);return o||new Response("Offline - Unable to fetch resource",{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"text/plain"}})}}async function W(e,t,s){let a=await caches.open(t),n=await a.match(e),o=fetch(e).then(async r=>{if(r.ok){let m=new Response(r.body,{status:r.status,statusText:r.statusText,headers:f(r.headers)});await a.put(e,m),await E(t,c.maxEntries.api)}return r}).catch(()=>null);if(n){let r=n.headers.get("sw-cache-time");if(r&&Date.now()-parseInt(r,10)>s*2){let g=await o;if(g)return g}return n}let i=await o;return i||new Response("Offline - Unable to fetch resource",{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"text/plain"}})}async function u(e,t){try{let s=await fetch(e);if(s.ok&&I(e.url)){let a=await caches.open(t),n=new Response(s.body,{status:s.status,statusText:s.statusText,headers:f(s.headers)});a.put(e,n)}return s}catch(s){console.warn("[Service Worker] Network failed, trying cache:",e.url);let n=await(await caches.open(t)).match(e);return n||(console.error("[Service Worker] Network-first error:",s),new Response("Offline - Unable to fetch resource",{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"text/plain"}}))}}function f(e){let t=new Headers(e);return t.set("sw-cache-time",Date.now().toString()),t}async function E(e,t){let s=await caches.open(e),a=await s.keys();if(a.length>t){let n=a.slice(0,a.length-t);await Promise.all(n.map(o=>s.delete(o)))}}function k(e){let t=e.pathname;return t==="/"||t==="/index.html"||t.endsWith(".js")||t.endsWith(".css")||t.endsWith(".json")||t.endsWith(".svg")||t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".ico")}function A(e){let t=e.pathname;return t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")||t.endsWith(".gif")||t.endsWith(".webp")||t.endsWith(".svg")}function x(e){return e.pathname.startsWith("/api/")}function S(e){return b.static.some(t=>t.test(e))}function T(e){return b.dynamic.some(t=>t.test(e))}function I(e){return S(e)||T(e)}function L(e){let t=e.hostname.toLowerCase();return C.some(s=>t.endsWith(s))?!0:/\/\d+\/\d+\/\d+\.(?:png|pbf|jpg|mvt)/.test(e.pathname)}function U(e){let t=e.hostname.toLowerCase();return t==="mapbox.com"||t.endsWith(".mapbox.com")||t==="cartocdn.com"||t.endsWith(".cartocdn.com")||t==="openstreetmap.org"||t.endsWith(".openstreetmap.org")}self.addEventListener("message",e=>{let t=self.location.origin;if(e.origin&&e.origin!==t){console.warn("[Service Worker] Ignoring message from untrusted origin:",e.origin);return}if(!e.source||!(e.source instanceof Client)){console.warn("[Service Worker] Ignoring message from invalid source");return}e.data&&e.data.type==="SKIP_WAITING"&&self.skipWaiting(),e.data&&e.data.type==="CLEAR_CACHE"&&e.waitUntil(caches.keys().then(s=>Promise.all(s.map(a=>caches.delete(a)))).then(()=>{console.log("[Service Worker] All caches cleared")}))});})();
